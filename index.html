<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>골프 예약 시스템</title>
    <!-- Tailwind CSS: 스타일링을 위한 라이브러리 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PapaParse: CSV 파일 처리를 위한 라이브러리 -->
    <script src="https://cdn.jsdelivr.net/npm/paparse@5.3.0/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .calendar-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        @media (max-width: 768px) { .calendar-container { grid-template-columns: 1fr; } }
        .day-cell { min-height: 50px; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; }
        .booking-info { font-size: 10px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 32px; border-radius: 16px; width: 90%; max-width: 480px; }
    </style>
</head>
<body class="bg-gray-100 p-8 md:p-16">

    <!-- 로그인 화면 -->
    <div id="loginScreen" class="flex flex-col items-center justify-center min-h-screen">
        <div class="bg-white rounded-3xl shadow-lg p-8 w-full max-w-sm">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">로그인</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginUsername" class="block text-sm font-medium text-gray-700">아이디 (이름)</label>
                    <input type="text" id="loginUsername" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700">비밀번호</label>
                    <input type="password" id="loginPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="rememberMe" name="remember-me" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="rememberMe" class="ml-2 block text-sm text-gray-900">아이디 저장</label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg">로그인</button>
            </form>
        </div>
    </div>

    <!-- 메인 앱 -->
    <div id="mainApp" class="hidden">
        <div class="bg-white rounded-3xl shadow-lg p-6 md:p-12 max-w-7xl mx-auto">
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">골프 예약 시스템</h1>
                <div class="flex items-center space-x-4">
                    <button id="openModalBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg">+ 신청</button>
                    <button id="logoutBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-full shadow-lg">로그아웃</button>
                </div>
            </header>
            <div class="mb-4 border-b border-gray-200">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="calendarTabBtn" class="px-3 py-2 font-medium text-sm rounded-md text-white bg-lime-500">캘린더</button>
                    <button id="statusTabBtn" class="px-3 py-2 font-medium text-sm rounded-md text-gray-500 hover:text-gray-700">현황</button>
                </nav>
            </div>
            <div id="calendarView" class="tab-content">
                <div id="golfCourseFilterContainer" class="mb-4 p-4 bg-gray-50 rounded-lg border"></div>
                <div id="calendar" class="calendar-container"></div>
            </div>
            <div id="statusView" class="tab-content hidden">
                 <div class="flex justify-end mb-4 gap-2">
                    <div id="adminOnlyControls" class="flex gap-2 hidden">
                        <button id="downloadExcelBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full">엑셀 다운로드</button>
                        <button id="uploadExcelBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">엑셀 업로드</button>
                    </div>
                    <button id="deleteSelectedBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full hidden">선택 삭제</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-left">선택</th>
                                <th class="py-3 px-6 text-left">Golf Course</th>
                                <th class="py-3 px-6 text-left">Name</th>
                                <th class="py-3 px-6 text-left">Date</th>
                                <th class="py-3 px-6 text-left">Team</th>
                                <th class="py-3 px-6 text-left">Time</th>
                                <th class="py-3 px-6 text-left">Status</th>
                                <th class="py-3 px-6 text-left">Comment</th>
                            </tr>
                        </thead>
                        <tbody id="statusTableBody" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- 예약 신청/수정 모달 -->
    <div id="bookingModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6 text-gray-800">예약 신청</h2>
            <form id="bookingForm" class="space-y-4">
                <input type="hidden" id="bookingId">
                <div><label for="userName" class="block text-sm font-medium text-gray-700">Name</label><input type="text" id="userName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="bookingDate" class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="bookingDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="golfCourse" class="block text-sm font-medium text-gray-700">Golf Course</label><select id="golfCourse" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-white"></select></div>
                <div><label for="numberOfTeams" class="block text-sm font-medium text-gray-700">Team</label><input type="number" id="numberOfTeams" min="1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="bookingTime" class="block text-sm font-medium text-gray-700">Time</label><input type="time" id="bookingTime" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="bookingStatus" class="block text-sm font-medium text-gray-700">Status</label><input type="text" id="bookingStatus" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="notes" class="block text-sm font-medium text-gray-700">Comment</label><input type="text" id="notes" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="closeModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-full">취소</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full">저장</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 엑셀 업로드 모달 -->
    <div id="uploadModal" class="modal-overlay">
         <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6">엑셀 파일 업로드</h2>
            <form id="uploadForm" class="space-y-4">
                <input type="file" id="excelFile" accept=".csv" required class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="closeUploadModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-full">취소</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">업로드</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ##### 설정 #####
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbypANRQj0iVm0gxo9YA88LjcSEWMEPuzIwYvLaAqjmNGg5kyPV0yJ0rkTZcUeK8iXow/exec';
        
        const users = [
            { name: "신석중", phone: "1010" }, { name: "강경민", phone: "5193" }, { name: "강민희", phone: "5307" },
            { name: "권승수", phone: "9260" }, { name: "김기홍", phone: "2241" }, { name: "김동훈", phone: "0008" }, { name: "김성현", phone: "3258" },
        ];
        
        const CALENDAR_GOLF_COURSES = ['레이크우드', '세라지오', '스카이밸리', '힐드로사이'];
        const MODAL_GOLF_COURSES = ['레이크우드', '스카이밸리', '세라지오', '힐드로사이'];

        // [수정됨] 골프장별 색상 설정
        const GOLF_COURSE_COLORS = {
            '레이크우드': 'text-black',
            '스카이밸리': 'text-blue-600',
            '세라지오': 'text-yellow-700',
            '힐드로사이': 'text-amber-800'
        };

        const holidays = {
            '2024-01-01': '신정', '2024-02-09': '설날', '2024-02-10': '설날', '2024-02-11': '설날',
            '2024-02-12': '설날 대체공휴일', '2024-03-01': '삼일절', '2024-04-10': '국회의원 선거',
            '2024-05-01': '근로자의 날', '2024-05-05': '어린이날', '2024-05-06': '어린이날 대체공휴일',
            '2024-05-15': '부처님 오신 날', '2024-06-06': '현충일', '2024-08-15': '광복절',
            '2024-09-16': '추석', '2024-09-17': '추석', '2024-09-18': '추석', '2024-10-03': '개천절',
            '2024-10-09': '한글날', '2024-12-25': '크리스마스',
            '2025-01-01': '신정', '2025-01-28': '설날', '2025-01-29': '설날', '2025-01-30': '설날',
            '2025-03-01': '삼일절', '2025-05-01': '근로자의 날', '2025-05-05': '어린이날',
            '2025-05-06': '부처님 오신 날', '2025-06-06': '현충일', '2025-08-15': '광복절',
            '2025-10-03': '개천절', '2025-10-06': '추석', '2025-10-07': '추석', '2025-10-08': '추석',
            '2025-10-09': '한글날', '2025-12-25': '크리스마스'
        };

        let currentUser = null;
        let bookings = [];
        
        const loginScreen = document.getElementById('loginScreen'), mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm'), logoutBtn = document.getElementById('logoutBtn');
        const calendarEl = document.getElementById('calendar'), statusTableBody = document.getElementById('statusTableBody');
        const openModalBtn = document.getElementById('openModalBtn'), bookingModal = document.getElementById('bookingModal');
        const closeModalBtn = document.getElementById('closeModalBtn'), bookingForm = document.getElementById('bookingForm');
        const calendarTabBtn = document.getElementById('calendarTabBtn'), statusTabBtn = document.getElementById('statusTabBtn');
        const calendarView = document.getElementById('calendarView'), statusView = document.getElementById('statusView');
        const adminOnlyControls = document.getElementById('adminOnlyControls'), deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn'), uploadExcelBtn = document.getElementById('uploadExcelBtn');
        const uploadModal = document.getElementById('uploadModal'), closeUploadModalBtn = document.getElementById('closeUploadModalBtn');
        const uploadForm = document.getElementById('uploadForm');
        const golfCourseFilterContainer = document.getElementById('golfCourseFilterContainer');

        document.addEventListener('DOMContentLoaded', () => {
            const savedUser = sessionStorage.getItem('golf_currentUser');
            if (savedUser) {
                currentUser = JSON.parse(savedUser);
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                initializeApp();
            } else {
                const savedUsername = localStorage.getItem('golf_username');
                const savedPassword = localStorage.getItem('golf_password');
                if (savedUsername && savedPassword) {
                    document.getElementById('loginUsername').value = savedUsername;
                    document.getElementById('loginPassword').value = savedPassword;
                    document.getElementById('rememberMe').checked = true;
                }
            }
        });

        async function initializeApp() {
            if (!currentUser) return;
            showLoading(true);
            await fetchBookings();
            setupGolfCourseFilters();
            renderCalendar();
            renderStatus();
            showLoading(false);
        }

        function showLoading(isLoading) { document.body.style.cursor = isLoading ? 'wait' : 'default'; }

        async function fetchBookings() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=read`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                bookings = await response.json();
            } catch (error) {
                console.error('Error fetching bookings:', error);
                alert('데이터를 불러오는 데 실패했습니다.');
            }
        }
        
        function setupGolfCourseFilters() {
            if (golfCourseFilterContainer.childElementCount > 0) return;
            let checkboxesHtml = '<div class="flex flex-wrap items-center gap-x-4 gap-y-2">';
            CALENDAR_GOLF_COURSES.forEach(course => {
                checkboxesHtml += `<div class="flex items-center"><input id="filter-${course}" type="checkbox" value="${course}" class="golf-course-filter h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked><label for="filter-${course}" class="ml-2 text-sm text-gray-900">${course}</label></div>`;
            });
            checkboxesHtml += `<div class="flex items-center border-l pl-4 ml-2"><input id="filter-my-bookings" type="checkbox" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"><label for="filter-my-bookings" class="ml-2 text-sm font-semibold text-gray-900">내 예약건</label></div>`;
            checkboxesHtml += '</div>';
            golfCourseFilterContainer.innerHTML = checkboxesHtml;
            golfCourseFilterContainer.addEventListener('change', renderCalendar);
        }

        function isWeekendOrHoliday(dateStr) {
            if (holidays[dateStr]) return true;
            const date = new Date(dateStr);
            const day = date.getDay();
            return day === 0 || day === 6;
        }

        function renderCalendar() {
            calendarEl.innerHTML = '';
            const calendarBookings = bookings.filter(b => CALENDAR_GOLF_COURSES.includes(b['Golf Course']));
            
            const selectedCourses = Array.from(document.querySelectorAll('.golf-course-filter:checked')).map(cb => cb.value);
            const showOnlyMyBookings = document.getElementById('filter-my-bookings').checked;
            
            let filteredBookings = calendarBookings;
            if (selectedCourses.length < CALENDAR_GOLF_COURSES.length) {
                 filteredBookings = filteredBookings.filter(b => selectedCourses.includes(b['Golf Course']));
            }
            if (showOnlyMyBookings) {
                filteredBookings = filteredBookings.filter(b => b.Name === currentUser.name);
            }

            const bookingMap = new Map();
            filteredBookings.forEach(booking => {
                const dateKey = booking['Date'];
                if (!bookingMap.has(dateKey)) bookingMap.set(dateKey, new Set());
                bookingMap.get(dateKey).add(booking['Golf Course']);
            });
            
            const courseAbbr = { '레이크우드': '레이크', '스카이밸리': '스카이', '세라지오': '세라', '힐드로사이': '힐드로' };
            const isMobile = window.innerWidth < 768;

            let currentDate = new Date();
            const limitDate = new Date(2025, 11, 31); 
            while(currentDate <= limitDate) {
                const year = currentDate.getFullYear(), month = currentDate.getMonth();
                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                const monthlyBookings = bookings.filter(b => {
                    const bookingDate = new Date(b.Date);
                    return bookingDate >= firstDayOfMonth && bookingDate <= lastDayOfMonth;
                });
                
                const userMonthlyBookings = monthlyBookings.filter(b => b.Name === currentUser.name);
                const quotaCounts = {
                    lakewood: userMonthlyBookings.filter(b => b['Golf Course'] === '레이크우드').length,
                    skyCeragio: userMonthlyBookings.filter(b => b['Golf Course'] === '스카이밸리' || b['Golf Course'] === '세라지오').length,
                    healdCiel: userMonthlyBookings.filter(b => b['Golf Course'] === '힐드로사이').length
                };

                const quotaHtml = `<div class="text-xs text-gray-600 grid grid-cols-3 gap-1 mb-1">
                    <span>레이크: ${quotaCounts.lakewood}/1</span>
                    <span>스카이/세라: ${quotaCounts.skyCeragio}/1</span>
                    <span>힐드로: ${quotaCounts.healdCiel}/0.5</span>
                </div>`;

                let warnings = [];
                const lakewoodWeekdayCount = monthlyBookings.filter(b => b['Golf Course'] === '레이크우드' && !isWeekendOrHoliday(b.Date)).length;
                const lakewoodWeekendCount = monthlyBookings.filter(b => b['Golf Course'] === '레이크우드' && isWeekendOrHoliday(b.Date)).length;
                if (lakewoodWeekdayCount >= 9) warnings.push('<div class="text-red-500 font-bold text-sm">※ 레이크우드 주중 한도 초과</div>');
                if (lakewoodWeekendCount >= 6) warnings.push('<div class="text-red-500 font-bold text-sm">※ 레이크우드 주말 한도 초과</div>');

                const seragioWeekdayCount = monthlyBookings.filter(b => b['Golf Course'] === '세라지오' && !isWeekendOrHoliday(b.Date)).length;
                const seragioWeekendCount = monthlyBookings.filter(b => b['Golf Course'] === '세라지오' && isWeekendOrHoliday(b.Date)).length;
                if (seragioWeekdayCount >= 5) warnings.push('<div class="text-red-500 font-bold text-sm">※ 세라지오 주중 한도 초과</div>');
                if (seragioWeekendCount >= 3) warnings.push('<div class="text-red-500 font-bold text-sm">※ 세라지오 주말 한도 초과</div>');

                const monthContainer = document.createElement('div');
                monthContainer.className = 'calendar-month bg-white p-6 rounded-lg shadow';
                monthContainer.innerHTML = `<div class="text-left mb-2 min-h-[4.5rem]">${quotaHtml}<div>${warnings.join('')}</div></div><div class="text-xl font-bold text-center mb-4">${year}년 ${month + 1}월</div><div class="grid grid-cols-7 gap-1 text-center text-sm font-semibold text-gray-600 mb-2"><div class="text-red-500">일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div class="text-blue-500">토</div></div>`;
                
                const dayGrid = document.createElement('div');
                dayGrid.className = 'grid grid-cols-7 gap-1 text-center';
                for (let j = 0; j < new Date(year, month, 1).getDay(); j++) dayGrid.innerHTML += '<div></div>';
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayOfWeek = new Date(year, month, day).getDay();
                    let dayColor = '';
                    if (dayOfWeek === 0 || holidays[dateStr]) dayColor = 'text-red-500';
                    else if (dayOfWeek === 6) dayColor = 'text-blue-500';
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell p-1 rounded-md';
                    let bookingHtml = '';
                    if (bookingMap.has(dateStr)) {
                        // [수정됨] 예약 있는 날 배경색 변경
                        dayCell.classList.add('bg-gray-200');
                        bookingMap.get(dateStr).forEach(course => { 
                            const displayName = isMobile ? (courseAbbr[course] || course) : course;
                            const textColor = GOLF_COURSE_COLORS[course] || 'text-gray-800';
                            // [수정됨] 골프장별 텍스트 색상 적용
                            bookingHtml += `<div class="booking-info ${textColor} font-semibold rounded px-1 truncate">${displayName}</div>`; 
                        });
                    }
                    dayCell.innerHTML = `<div class="day-number font-medium ${dayColor}">${day}</div>` + bookingHtml;
                    dayGrid.appendChild(dayCell);
                }
                monthContainer.appendChild(dayGrid);
                calendarEl.appendChild(monthContainer);
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
        }

        function renderStatus() {
            statusTableBody.innerHTML = '';
            const isManager = currentUser && currentUser.name === '신석중';
            let filteredBookings = isManager ? bookings : bookings.filter(b => b['Name'] === currentUser.name);
            
            adminOnlyControls.classList.toggle('hidden', !isManager);
            deleteSelectedBtn.classList.toggle('hidden', !currentUser);

            if (filteredBookings.length === 0) {
                 statusTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-10">예약 내역이 없습니다.</td></tr>`;
                 return;
            }
            filteredBookings.forEach(booking => {
                const row = document.createElement('tr');
                let statusStyle = "border-b border-gray-200 hover:bg-gray-100";
                if (booking['Status'] === '완료') {
                    statusStyle = "border-b border-gray-200 bg-sky-100 text-blue-700 font-medium";
                }
                row.className = statusStyle;
                let displayTime = '-';
                const timeValue = booking['Time'];
                if (timeValue && typeof timeValue === 'string') {
                    const match = timeValue.match(/(\d{1,2}:\d{2})/);
                    displayTime = match ? match[0] : timeValue;
                } else if (timeValue) displayTime = timeValue;
                row.innerHTML = `<td class="py-3 px-6"><input type="checkbox" class="booking-checkbox" data-id="${booking.id}"></td><td class="py-3 px-6">${booking['Golf Course']}</td><td class="py-3 px-6">${booking['Name']}</td><td class="py-3 px-6">${booking['Date']}</td><td class="py-3 px-6">${booking['Team']}</td><td class="py-3 px-6">${displayTime}</td><td class="py-3 px-6">${booking['Status'] || '-'}</td><td class="py-3 px-6">${booking['Comment'] || '-'}</td>`;
                if (isManager || booking['Name'] === currentUser.name) {
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', (e) => { if (e.target.type !== 'checkbox') openBookingModal(booking); });
                }
                statusTableBody.appendChild(row);
            });
        }
        
        async function postData(action, data) {
            showLoading(true);
            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action, ...data }) });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                alert(result.message);
                await initializeApp();
            } catch (error) {
                console.error(`Error with action ${action}:`, error);
                alert(`오류가 발생했습니다: ${error.message}`);
            } finally { showLoading(false); }
        }

        function updateAvailableGolfCourses(selectedDate) {
            const golfCourseSelect = document.getElementById('golfCourse');
            golfCourseSelect.innerHTML = '';
            if (!selectedDate) return;

            const isManager = currentUser.name === '신석중';
            
            const isDayWeekendOrHoliday = isWeekendOrHoliday(selectedDate);
            const dailyCounts = bookings.filter(b => b.Date === selectedDate).reduce((acc, b) => {
                acc[b['Golf Course']] = (acc[b['Golf Course']] || 0) + 1;
                return acc;
            }, {});
            const lakewoodDailyCount = dailyCounts['레이크우드'] || 0;
            const seragioDailyCount = dailyCounts['세라지오'] || 0;
            const isLakewoodOverDailyLimit = isDayWeekendOrHoliday ? lakewoodDailyCount >= 6 : lakewoodDailyCount >= 9;
            const isSeragioOverDailyLimit = isDayWeekendOrHoliday ? seragioDailyCount >= 3 : seragioDailyCount >= 5;

            const year = new Date(selectedDate).getFullYear();
            const month = new Date(selectedDate).getMonth();
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const userMonthlyBookings = bookings.filter(b => {
                const bookingDate = new Date(b.Date);
                return b.Name === currentUser.name && bookingDate >= firstDayOfMonth && bookingDate <= lastDayOfMonth;
            });

            const userQuotaCounts = {
                lakewood: userMonthlyBookings.filter(b => b['Golf Course'] === '레이크우드').length,
                skyCeragio: userMonthlyBookings.filter(b => b['Golf Course'] === '스카이밸리' || b['Golf Course'] === '세라지오').length,
                healdCiel: userMonthlyBookings.filter(b => b['Golf Course'] === '힐드로사이').length
            };
            
            MODAL_GOLF_COURSES.forEach(course => {
                let isOverDailyLimit = false;
                if (course === '레이크우드' && isLakewoodOverDailyLimit) isOverDailyLimit = true;
                if (course === '세라지오' && isSeragioOverDailyLimit) isOverDailyLimit = true;
                
                let isOverUserQuota = false;
                if (!isManager) {
                    if (course === '레이크우드' && userQuotaCounts.lakewood >= 1) isOverUserQuota = true;
                    if ((course === '스카이밸리' || course === '세라지오') && userQuotaCounts.skyCeragio >= 1) isOverUserQuota = true;
                    if (course === '힐드로사이' && userQuotaCounts.healdCiel >= 1) isOverUserQuota = true;
                }
                
                if (!isOverDailyLimit && !isOverUserQuota) {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    golfCourseSelect.appendChild(option);
                }
            });
        }

        function openBookingModal(booking = null) {
            bookingForm.reset();
            const isManager = currentUser.name === '신석중';
            const userNameInput = document.getElementById('userName');
            const bookingTimeInput = document.getElementById('bookingTime');
            const bookingStatusInput = document.getElementById('bookingStatus');

            [userNameInput, bookingTimeInput, bookingStatusInput].forEach(input => {
                input.disabled = !isManager;
                input.classList.toggle('bg-gray-200', !isManager);
            });
            
            document.getElementById('bookingDate').addEventListener('change', (e) => updateAvailableGolfCourses(e.target.value));

            if (booking) { // 수정 모드
                document.getElementById('modalTitle').textContent = '예약 수정';
                const golfCourseSelect = document.getElementById('golfCourse');
                golfCourseSelect.innerHTML = '';
                MODAL_GOLF_COURSES.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    golfCourseSelect.appendChild(option);
                });
                document.getElementById('bookingId').value = booking.id;
                golfCourseSelect.value = booking['Golf Course'];
                userNameInput.value = booking['Name'];
                document.getElementById('bookingDate').value = booking['Date'];
                document.getElementById('numberOfTeams').value = booking['Team'];
                bookingTimeInput.value = booking['Time'];
                bookingStatusInput.value = booking['Status'];
                document.getElementById('notes').value = booking['Comment'];
            } else { // 신규 모드
                document.getElementById('modalTitle').textContent = '예약 신청';
                userNameInput.value = currentUser.name;
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('bookingDate').value = today;
                updateAvailableGolfCourses(today);
            }
            bookingModal.style.display = 'flex';
        }

        function downloadExcel() {
            if (bookings.length === 0) return alert('다운로드할 데이터가 없습니다.');
            const headers = ["id", "Golf Course", "Name", "Date", "Team", "Time", "Status", "Comment"];
            const csv = Papa.unparse({ fields: headers, data: bookings });
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'golf_bookings.csv';
            link.click();
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const user = users.find(u => u.name === username && u.phone === password);

            if (user) {
                currentUser = user;
                sessionStorage.setItem('golf_currentUser', JSON.stringify(currentUser));
                const rememberMe = document.getElementById('rememberMe').checked;
                if (rememberMe) {
                    localStorage.setItem('golf_username', username);
                    localStorage.setItem('golf_password', password);
                } else {
                    localStorage.removeItem('golf_username');
                    localStorage.removeItem('golf_password');
                }
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                await initializeApp();
            } else { 
                alert('아이디 또는 비밀번호가 일치하지 않습니다.'); 
            }
        });

        logoutBtn.addEventListener('click', () => {
            currentUser = null;
            sessionStorage.removeItem('golf_currentUser');
            mainApp.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            loginForm.reset();
            const savedUsername = localStorage.getItem('golf_username');
            if (savedUsername) {
                document.getElementById('loginUsername').value = savedUsername;
                document.getElementById('loginPassword').value = localStorage.getItem('golf_password');
                document.getElementById('rememberMe').checked = true;
            }
        });

        calendarTabBtn.addEventListener('click', () => {
            calendarView.classList.remove('hidden'); statusView.classList.add('hidden');
            calendarTabBtn.classList.add('bg-lime-500', 'text-white');
            statusTabBtn.classList.remove('bg-lime-500', 'text-white');
        });
        statusTabBtn.addEventListener('click', () => {
            statusView.classList.remove('hidden'); calendarView.classList.add('hidden');
            statusTabBtn.classList.add('bg-lime-500', 'text-white');
            calendarTabBtn.classList.remove('bg-lime-500', 'text-white');
        });
        
        openModalBtn.addEventListener('click', () => openBookingModal());
        closeModalBtn.addEventListener('click', () => bookingModal.style.display = 'none');
        
        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const bookingData = {
                'id': document.getElementById('bookingId').value,
                'Golf Course': document.getElementById('golfCourse').value,
                'Name': document.getElementById('userName').value,
                'Date': document.getElementById('bookingDate').value,
                'Team': document.getElementById('numberOfTeams').value,
                'Time': document.getElementById('bookingTime').value,
                'Status': document.getElementById('bookingStatus').value,
                'Comment': document.getElementById('notes').value
            };
            if (!bookingData['Golf Course']) {
                alert('선택한 날짜에 예약 가능한 골프장이 없습니다. 한도가 초과되었을 수 있습니다.');
                return;
            }
            if (!bookingData.id) {
                const isDuplicate = bookings.some(b => b.Date === bookingData.Date && b['Golf Course'] === bookingData['Golf Course'] && b.Name === bookingData.Name);
                if (isDuplicate) {
                    alert('이미 해당 날짜에 동일한 골프장으로 예약한 내역이 있습니다.');
                    return;
                }
            }
            await postData(bookingData.id ? 'update' : 'add', { booking: bookingData });
            bookingModal.style.display = 'none';
        });

        deleteSelectedBtn.addEventListener('click', async () => {
            const checkedBoxes = document.querySelectorAll('.booking-checkbox:checked');
            if (checkedBoxes.length === 0) return alert('삭제할 항목을 선택하세요.');

            const isManager = currentUser.name === '신석중';
            let idsToDelete = Array.from(checkedBoxes).map(cb => cb.dataset.id);

            if (!isManager) {
                const myBookingsIds = new Set(bookings.filter(b => b.Name === currentUser.name).map(b => b.id));
                const originalLength = idsToDelete.length;
                idsToDelete = idsToDelete.filter(id => myBookingsIds.has(id));
                if (idsToDelete.length < originalLength) {
                    alert('자신의 예약만 삭제할 수 있습니다. 타인의 예약을 제외하고 진행합니다.');
                }
            }
            
            if (idsToDelete.length === 0) {
                alert('삭제할 수 있는 예약이 없습니다.');
                return;
            };

            if (confirm(`선택한 ${idsToDelete.length}개의 항목을 정말 삭제하시겠습니까?`)) {
                await postData('delete', { ids: idsToDelete });
            }
        });

        uploadExcelBtn.addEventListener('click', () => uploadModal.style.display = 'flex');
        closeUploadModalBtn.addEventListener('click', () => uploadModal.style.display = 'none');
        uploadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const file = document.getElementById('excelFile').files[0];
            if (!file) return alert('파일을 선택해주세요.');
            Papa.parse(file, {
                header: true, skipEmptyLines: true,
                complete: async (results) => {
                    await postData('addMultiple', { bookings: results.data });
                    uploadModal.style.display = 'none';
                },
                error: (err) => { alert('파일을 읽는 중 오류가 발생했습니다.'); console.error(err); }
            });
        });
    </script>
</body>
</html>

