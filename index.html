<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>골프 예약 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .calendar-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        @media (max-width: 768px) { .calendar-container { grid-template-columns: 1fr; } }
        .day-cell { min-height: 50px; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; }
        .booking-info { font-size: 10px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 32px; border-radius: 16px; width: 90%; max-width: 480px; }
    </style>
</head>
<body class="bg-gray-100 p-8 md:p-16">

    <div id="loginScreen" class="flex flex-col items-center justify-center min-h-screen">
        <div class="bg-white rounded-3xl shadow-lg p-8 w-full max-w-sm">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">로그인</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginUsername" class="block text-sm font-medium text-gray-700">아이디 (이름)</label>
                    <input type="text" id="loginUsername" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700">비밀번호 (핸드폰 뒷자리)</label>
                    <input type="password" id="loginPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                </div>
                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg">로그인</button>
            </form>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <div class="bg-white rounded-3xl shadow-lg p-6 md:p-12 max-w-7xl mx-auto">
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">골프 예약 시스템</h1>
                <div class="flex items-center space-x-4">
                    <button id="openModalBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg">+ 신청</button>
                    <button id="logoutBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-full shadow-lg">로그아웃</button>
                </div>
            </header>
            <div class="mb-4 border-b border-gray-200">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="calendarTabBtn" class="px-3 py-2 font-medium text-sm rounded-md text-white bg-lime-500">캘린더</button>
                    <button id="statusTabBtn" class="px-3 py-2 font-medium text-sm rounded-md text-gray-500 hover:text-gray-700">현황</button>
                </nav>
            </div>
            <div id="calendarView" class="tab-content"><div id="calendar" class="calendar-container"></div></div>
            <div id="statusView" class="tab-content hidden">
                 <div id="adminControls" class="flex justify-end mb-4 gap-2 hidden">
                    <button id="downloadExcelBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full">엑셀 다운로드</button>
                    <button id="uploadExcelBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">엑셀 업로드</button>
                    <button id="deleteSelectedBtn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-full">선택 삭제</button>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-left">선택</th>
                                <th class="py-3 px-6 text-left">Golf Course</th>
                                <th class="py-3 px-6 text-left">Name</th>
                                <th class="py-3 px-6 text-left">Date</th>
                                <th class="py-3 px-6 text-left">Team</th>
                                <th class="py-3 px-6 text-left">Time</th>
                                <th class="py-3 px-6 text-left">Status</th>
                                <th class="py-3 px-6 text-left">Comment</th>
                            </tr>
                        </thead>
                        <tbody id="statusTableBody" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="bookingModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6 text-gray-800">예약 신청</h2>
            <form id="bookingForm" class="space-y-4">
                <input type="hidden" id="bookingId">
                <div><label for="golfCourse" class="block text-sm font-medium text-gray-700">Golf Course</label><input type="text" id="golfCourse" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="userName" class="block text-sm font-medium text-gray-700">Name</label><input type="text" id="userName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="bookingDate" class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="bookingDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="numberOfTeams" class="block text-sm font-medium text-gray-700">Team</label><input type="number" id="numberOfTeams" min="1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="bookingTime" class="block text-sm font-medium text-gray-700">Time</label><input type="time" id="bookingTime" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="bookingStatus" class="block text-sm font-medium text-gray-700">Status</label><input type="text" id="bookingStatus" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="notes" class="block text-sm font-medium text-gray-700">Comment</label><input type="text" id="notes" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="closeModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-full">취소</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full">저장</button>
                </div>
            </form>
        </div>
    </div>

    <div id="uploadModal" class="modal-overlay">
         <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6">엑셀 파일 업로드</h2>
            <form id="uploadForm" class="space-y-4">
                <input type="file" id="excelFile" accept=".csv" required class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="closeUploadModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-full">취소</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">업로드</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // ##### 설정 #####
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbypANRQj0iVm0gxo9YA88LjcSEWMEPuzIwYvLaAqjmNGg5kyPV0yJ0rkTZcUeK8iXow/exec';
        
        const users = [
            { name: "신석중", phone: "1010" }, { name: "강경민", phone: "5193" }, { name: "강민희", phone: "5307" },
            { name: "권승수", phone: "9260" }, { name: "김기홍", phone: "2241" }, { name: "김동훈", phone: "0008" }, { name: "김성현", phone: "3258" },
        ];

        let currentUser = null;
        let bookings = [];
        
        const loginScreen = document.getElementById('loginScreen'), mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm'), logoutBtn = document.getElementById('logoutBtn');
        const calendarEl = document.getElementById('calendar'), statusTableBody = document.getElementById('statusTableBody');
        const openModalBtn = document.getElementById('openModalBtn'), bookingModal = document.getElementById('bookingModal');
        const closeModalBtn = document.getElementById('closeModalBtn'), bookingForm = document.getElementById('bookingForm');
        const calendarTabBtn = document.getElementById('calendarTabBtn'), statusTabBtn = document.getElementById('statusTabBtn');
        const calendarView = document.getElementById('calendarView'), statusView = document.getElementById('statusView');
        const adminControls = document.getElementById('adminControls'), deleteSelectedBtn = document.getElementById('deleteSelectedBtn');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn'), uploadExcelBtn = document.getElementById('uploadExcelBtn');
        const uploadModal = document.getElementById('uploadModal'), closeUploadModalBtn = document.getElementById('closeUploadModalBtn');
        const uploadForm = document.getElementById('uploadForm');

        async function initializeApp() {
            if (!currentUser) return;
            showLoading(true);
            await fetchBookings();
            renderCalendar();
            renderStatus();
            showLoading(false);
        }

        function showLoading(isLoading) { document.body.style.cursor = isLoading ? 'wait' : 'default'; }

        async function fetchBookings() {
            try {
                const response = await fetch(`${SCRIPT_URL}?action=read`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                bookings = await response.json();
            } catch (error) {
                console.error('Error fetching bookings:', error);
                alert('데이터를 불러오는 데 실패했습니다.');
            }
        }

        function renderCalendar() {
            calendarEl.innerHTML = '';
            const bookingMap = new Map();
            bookings.forEach(booking => {
                const dateKey = booking['Date'];
                if (!bookingMap.has(dateKey)) bookingMap.set(dateKey, []);
                bookingMap.get(dateKey).push(booking['Golf Course']);
            });
            let currentDate = new Date(new Date().getFullYear(), new Date().getMonth(), 1);
            for(let i = 0; i < 12; i++) {
                const year = currentDate.getFullYear(), month = currentDate.getMonth();
                const monthContainer = document.createElement('div');
                monthContainer.className = 'calendar-month bg-white p-6 rounded-lg shadow';
                monthContainer.innerHTML = `<div class="text-xl font-bold text-center mb-4">${year}년 ${month + 1}월</div><div class="grid grid-cols-7 gap-1 text-center text-sm font-semibold text-gray-600 mb-2"><div class="text-red-500">일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div class="text-blue-500">토</div></div>`;
                const dayGrid = document.createElement('div');
                dayGrid.className = 'grid grid-cols-7 gap-1 text-center';
                for (let j = 0; j < new Date(year, month, 1).getDay(); j++) dayGrid.innerHTML += '<div></div>';
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayOfWeek = new Date(year, month, day).getDay();
                    let dayColor = (dayOfWeek === 0) ? 'text-red-500' : (dayOfWeek === 6) ? 'text-blue-500' : '';
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell p-1 rounded-md';
                    let bookingHtml = '';
                    if (bookingMap.has(dateStr)) {
                        dayCell.classList.add('bg-lime-100');
                        bookingMap.get(dateStr).forEach(course => { bookingHtml += `<div class="booking-info bg-lime-500 text-white rounded px-1 truncate">${course}</div>`; });
                    }
                    dayCell.innerHTML = `<div class="day-number font-medium ${dayColor}">${day}</div>` + bookingHtml;
                    dayGrid.appendChild(dayCell);
                }
                monthContainer.appendChild(dayGrid);
                calendarEl.appendChild(monthContainer);
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
        }

        function renderStatus() {
            statusTableBody.innerHTML = '';
            const isManager = currentUser && currentUser.name === '신석중';
            adminControls.classList.toggle('hidden', !isManager);
            let filteredBookings = isManager ? bookings : bookings.filter(b => b['Name'] === currentUser.name);
            if (filteredBookings.length === 0) {
                 statusTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-10">예약 내역이 없습니다.</td></tr>`;
                 return;
            }
            filteredBookings.forEach(booking => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-100';
                row.innerHTML = `<td class="py-3 px-6"><input type="checkbox" class="booking-checkbox" data-id="${booking.id}"></td>
                    <td class="py-3 px-6">${booking['Golf Course']}</td><td class="py-3 px-6">${booking['Name']}</td>
                    <td class="py-3 px-6">${booking['Date']}</td><td class="py-3 px-6">${booking['Team']}</td>
                    <td class="py-3 px-6">${booking['Time'] || '-'}</td><td class="py-3 px-6">${booking['Status'] || '-'}</td>
                    <td class="py-3 px-6">${booking['Comment'] || '-'}</td>`;
                if (isManager || booking['Name'] === currentUser.name) {
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', (e) => { if (e.target.type !== 'checkbox') openBookingModal(booking); });
                }
                statusTableBody.appendChild(row);
            });
        }
        
        async function postData(action, data) {
            showLoading(true);
            try {
                const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action, ...data }) });
                const result = await response.json();
                if (result.status !== 'success') throw new Error(result.message);
                alert(result.message);
                await initializeApp();
            } catch (error) {
                console.error(`Error with action ${action}:`, error);
                alert(`오류가 발생했습니다: ${error.message}`);
            } finally { showLoading(false); }
        }

        function openBookingModal(booking = null) {
            bookingForm.reset();
            if (booking) {
                document.getElementById('modalTitle').textContent = '예약 수정';
                document.getElementById('bookingId').value = booking.id;
                document.getElementById('golfCourse').value = booking['Golf Course'];
                document.getElementById('userName').value = booking['Name'];
                document.getElementById('bookingDate').value = booking['Date'];
                document.getElementById('numberOfTeams').value = booking['Team'];
                document.getElementById('bookingTime').value = booking['Time'];
                document.getElementById('bookingStatus').value = booking['Status'];
                document.getElementById('notes').value = booking['Comment'];
            } else {
                document.getElementById('modalTitle').textContent = '예약 신청';
                document.getElementById('userName').value = currentUser.name;
            }
            bookingModal.style.display = 'flex';
        }

        function downloadExcel() {
            if (bookings.length === 0) return alert('다운로드할 데이터가 없습니다.');
            const headers = ["id", "Golf Course", "Name", "Date", "Team", "Time", "Status", "Comment"];
            const csv = Papa.unparse({ fields: headers, data: bookings });
            const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'golf_bookings.csv';
            link.click();
        }

        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = document.getElementById('loginUsername').value;
            const password = document.getElementById('loginPassword').value;
            const user = users.find(u => u.name === username && u.phone === password);
            if (user) {
                currentUser = user;
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                await initializeApp();
            } else { alert('아이디 또는 비밀번호가 일치하지 않습니다.'); }
        });

        logoutBtn.addEventListener('click', () => {
            currentUser = null;
            mainApp.classList.add('hidden');
            loginScreen.classList.remove('hidden');
            loginForm.reset();
        });

        calendarTabBtn.addEventListener('click', () => {
            calendarView.classList.remove('hidden'); statusView.classList.add('hidden');
            calendarTabBtn.classList.add('bg-lime-500', 'text-white');
            statusTabBtn.classList.remove('bg-lime-500', 'text-white');
        });
        statusTabBtn.addEventListener('click', () => {
            statusView.classList.remove('hidden'); calendarView.classList.add('hidden');
            statusTabBtn.classList.add('bg-lime-500', 'text-white');
            calendarTabBtn.classList.remove('bg-lime-500', 'text-white');
        });
        
        openModalBtn.addEventListener('click', () => openBookingModal());
        closeModalBtn.addEventListener('click', () => bookingModal.style.display = 'none');
        
        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const bookingData = {
                'id': document.getElementById('bookingId').value,
                'Golf Course': document.getElementById('golfCourse').value,
                'Name': document.getElementById('userName').value,
                'Date': document.getElementById('bookingDate').value,
                'Team': document.getElementById('numberOfTeams').value,
                'Time': document.getElementById('bookingTime').value,
                'Status': document.getElementById('bookingStatus').value,
                'Comment': document.getElementById('notes').value
            };
            await postData(bookingData.id ? 'update' : 'add', { booking: bookingData });
            bookingModal.style.display = 'none';
        });

        deleteSelectedBtn.addEventListener('click', async () => {
            const checkedBoxes = document.querySelectorAll('.booking-checkbox:checked');
            if (checkedBoxes.length === 0) return alert('삭제할 항목을 선택하세요.');
            if (confirm(`선택한 ${checkedBoxes.length}개의 항목을 정말 삭제하시겠습니까?`)) {
                const idsToDelete = Array.from(checkedBoxes).map(cb => cb.dataset.id);
                await postData('delete', { ids: idsToDelete });
            }
        });

        uploadExcelBtn.addEventListener('click', () => uploadModal.style.display = 'flex');
        closeUploadModalBtn.addEventListener('click', () => uploadModal.style.display = 'none');
        uploadForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const file = document.getElementById('excelFile').files[0];
            if (!file) return alert('파일을 선택해주세요.');
            Papa.parse(file, {
                header: true, skipEmptyLines: true,
                complete: async (results) => {
                    await postData('addMultiple', { bookings: results.data });
                    uploadModal.style.display = 'none';
                },
                error: (err) => { alert('파일을 읽는 중 오류가 발생했습니다.'); console.error(err); }
            });
        });
    </script>
</body>
</html>
