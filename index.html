<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>골프 예약 시스템 (fixed)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .calendar-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        @media (max-width: 768px) { .calendar-container { grid-template-columns: 1fr; } }
        .day-cell { min-height: 50px; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; cursor: pointer; }
        .booking-info { font-size: 10px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 32px; border-radius: 16px; width: 90%; max-width: 480px; }
        #anonymousView table th, #anonymousView table td { text-align: center; border: 1px solid #e5e7eb; padding: 4px; font-size: 0.75rem; }
        #anonymousView table th { background-color: #f9fafb; }
        #lookupResults table th, #lookupResults table td { border: 1px solid #e2e8f0; padding: 8px; text-align: center; }
        #lookupResults table th { background-color: #f8fafc; }
    </style>
</head>
<body class="bg-gray-100 p-8 md:p-16">

    <!-- 로그인 화면 -->
    <div id="loginScreen" class="flex flex-col items-center justify-center min-h-screen">
        <div class="bg-white rounded-3xl shadow-lg p-8 w-full max-w-sm">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">로그인</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginUsername" class="block text-sm font-medium text-gray-700">아이디 (이름)</label>
                    <input type="text" id="loginUsername" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700">비밀번호</label>
                    <input type="password" id="loginPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="rememberMe" name="remember-me" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="rememberMe" class="ml-2 block text-sm text-gray-900">아이디 저장</label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg">로그인</button>
            </form>
        </div>
    </div>

    <!-- 메인 앱 -->
    <div id="mainApp" class="hidden">
        <div class="bg-white rounded-3xl shadow-lg p-6 md:p-12 max-w-7xl mx-auto">
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div class="flex-grow">
                    <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">골프 예약 시스템</h1>
                    <a href="#" id="noticeLink" class="text-sm text-blue-600 hover:underline">이용 및 취소 안내(2025.9월)</a>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="openModalBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition-transform active:scale-95">+ 신청</button>
                    <button id="logoutBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-full">로그아웃</button>
                </div>
            </header>
            <div class="mb-4 border-b border-gray-200">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="calendarTabBtn" class="px-3 py-2 font-medium text-sm rounded-md text-white bg-lime-500">캘린더</button>
                    <button id="statusTabBtn" class="px-3 py-2 font-medium text-sm rounded-md text-gray-500 hover:text-gray-700">현황</button>
                    <button id="lookupTabBtn" class="px-3 py-2 font-medium text-sm rounded-md text-gray-500 hover:text-gray-700 hidden">조회</button>
                    <button id="anonymousTabBtn" class="px-3 py-2 font-medium text-sm rounded-md text-gray-500 hover:text-gray-700 hidden">무기명</button>
                </nav>
            </div>
            <div id="calendarView" class="tab-content">
                <div id="golfCourseFilterContainer" class="mb-4 p-4 bg-gray-50 rounded-lg border"></div>
                <div id="calendar" class="calendar-container"></div>
            </div>
            <div id="statusView" class="tab-content hidden">
                 <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <div id="statusFilterContainer" class="flex flex-wrap items-center gap-x-4 gap-y-2">
                    </div>
                    <div class="flex gap-2">
                        <div id="adminOnlyControls" class="flex gap-2 hidden">
                            <button id="downloadExcelBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full">엑셀 다운로드</button>
                            <button id="uploadExcelBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">엑셀 업로드</button>
                        </div>
                        <button id="cancelSelectedBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-full hidden transform transition-transform active:scale-95">선택 취소</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead id="statusTableHead" class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-6 text-left">선택</th>
                                <th class="py-3 px-6 text-left cursor-pointer" data-sort="Golf Course">Golf Course <span class="sort-indicator"></span></th>
                                <th class="py-3 px-6 text-left cursor-pointer" data-sort="Name">Name <span class="sort-indicator"></span></th>
                                <th class="py-3 px-6 text-left cursor-pointer" data-sort="Date">Date <span class="sort-indicator"></span></th>
                                <th class="py-3 px-6 text-left cursor-pointer" data-sort="Team">Team <span class="sort-indicator"></span></th>
                                <th class="py-3 px-6 text-left cursor-pointer" data-sort="Time">Time <span class="sort-indicator"></span></th>
                                <th class="py-3 px-6 text-left cursor-pointer" data-sort="Status">Status <span class="sort-indicator"></span></th>
                                <th class="py-3 px-6 text-left cursor-pointer" data-sort="Comment">Comment <span class="sort-indicator"></span></th>
                            </tr>
                        </thead>
                        <tbody id="statusTableBody" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>
            <div id="lookupView" class="tab-content hidden">
                <div class="bg-gray-50 p-4 rounded-lg border mb-4">
                    <div class="flex flex-col md:flex-row items-center gap-4">
                         <div class="flex items-center gap-2">
                             <label for="lookupName" class="text-sm font-medium text-gray-700">성명</label>
                             <input type="text" id="lookupName" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                         </div>
                         <div class="flex items-center gap-2">
                            <label for="lookupDate" class="text-sm font-medium text-gray-700">일자</label>
                            <input type="date" id="lookupDate" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                         </div>
                         <button id="lookupBtn" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full self-end">조회</button>
                    </div>
                </div>
                <div id="lookupResults" class="mt-6 space-y-6"></div>
            </div>
            <div id="anonymousView" class="tab-content hidden">
                <div class="flex justify-end mb-4">
                    <select id="anonymousYearSelector" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="2024">2024년</option>
                        <option value="2025">2025년</option>
                    </select>
                </div>
                <div id="anonymousTableContainer" class="overflow-x-auto"></div>
            </div>
        </div>
    </div>

    <!-- 예약 신청/수정 모달 -->
    <div id="bookingModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6 text-gray-800">예약 신청</h2>
            <form id="bookingForm" class="space-y-4">
                <input type="hidden" id="bookingId">
                <div><label for="userName" class="block text-sm font-medium text-gray-700">Name</label><input type="text" id="userName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="bookingDate" class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="bookingDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="golfCourse" class="block text-sm font-medium text-gray-700">Golf Course</label><select id="golfCourse" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-white"></select></div>
                <div><label for="numberOfTeams" class="block text-sm font-medium text-gray-700">Team</label><input type="number" id="numberOfTeams" min="1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="bookingTime" class="block text-sm font-medium text-gray-700">Time</label><input type="time" id="bookingTime" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="bookingStatus" class="block text-sm font-medium text-gray-700">Status</label><input type="text" id="bookingStatus" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="notes" class="block text-sm font-medium text-gray-700">Comment</label><input type="text" id="notes" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="closeModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-full">취소</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full transform transition-transform active:scale-95">저장</button>
                </div>
            </form>
        </div>
    </div>
    
    <!-- 공지사항 모달 -->
    <div id="noticeModal" class="modal-overlay">
        <div class="modal-content relative max-w-3xl max-h-[80vh] overflow-y-auto">
            <button id="closeNoticeBtn" class="absolute top-4 right-4 text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            <h2 class="text-2xl font-bold mb-2 text-center text-gray-800">골프예약시스템 안내</h2>
            <p class="text-sm text-center text-gray-500 mb-6">[2025.09월, 인사총무팀]</p>
            <div class="prose max-w-none text-gray-700 space-y-4">
                <p class="text-sm">본 페이지는 다운로드 테스트를 위해 최소 동작으로 구성되어 있습니다.</p>
            </div>
        </div>
    </div>


    <div id="loadingOverlay" class="modal-overlay" style="display: none;">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <script>
        // ##### 설정 #####
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbypANRQj0iVm0gxo9YA88LjcSEWMEPuzIwYvLaAqjmNGg5kyPV0yJ0rkTZcUeK8iXow/exec';
        
        const CALENDAR_GOLF_COURSES = ['레이크우드', '스카이밸리', '세라지오', '힐드로사이'];
        const MODAL_GOLF_COURSES = ['레이크우드', '스카이밸리', '세라지오', '힐드로사이'];

        const GOLF_COURSE_COLORS = {
            '레이크우드': 'text-black',
            '스카이밸리': 'text-blue-600',
            '세라지오': 'text-green-600',
            '힐드로사이': 'text-red-600'
        };

        const holidays = {
            '2024-01-01': '신정','2024-02-09': '설날','2024-02-10': '설날','2024-02-11': '설날','2024-02-12': '설날 대체공휴일','2024-03-01': '삼일절','2024-04-10': '국회의원 선거','2024-05-01': '근로자의 날','2024-05-05': '어린이날','2024-05-06': '어린이날 대체공휴일','2024-05-15': '부처님 오신 날','2024-06-06': '현충일','2024-08-15': '광복절','2024-09-16': '추석','2024-09-17': '추석','2024-09-18': '추석','2024-10-03': '개천절','2024-10-09': '한글날','2024-12-25': '크리스마스',
            '2025-01-01': '신정','2025-01-28': '설날','2025-01-29': '설날','2025-01-30': '설날','2025-03-01': '삼일절','2025-05-01': '근로자의 날','2025-05-05': '어린이날','2025-05-06': '부처님 오신 날','2025-06-06': '현충일','2025-08-15': '광복절','2025-10-03': '개천절','2025-10-06': '추석','2025-10-07': '추석','2025-10-08': '추석','2025-10-09': '한글날','2025-12-25': '크리스마스'
        };

        let currentUser = { name: '신석중', phone: 'demo' }; // 데모용 기본 로그인 상태
        let bookings = [
            // 데모 데이터(다운로드 동작 확인용)
            {id: '1', 'Golf Course': '레이크우드', Name: '홍길동', Date: '2025-10-16', Team: '1', Time: '08:00', Status: '확정', Comment: ''},
            {id: '2', 'Golf Course': '스카이밸리', Name: '임꺽정', Date: '2025-09-02', Team: '2', Time: '09:10', Status: '확정', Comment: '메모'}
        ];
        let userQuotas = {};
        let users = [{name:'신석중', phone:'demo'}];
        let originalBookingForLog = null;
        let sortColumn = 'Date';
        let sortDirection = 'asc';
        
        const loginScreen = document.getElementById('loginScreen'), mainApp = document.getElementById('mainApp');
        const loginForm = document.getElementById('loginForm'), logoutBtn = document.getElementById('logoutBtn');
        const calendarEl = document.getElementById('calendar'), statusTableBody = document.getElementById('statusTableBody');
        const openModalBtn = document.getElementById('openModalBtn'), bookingModal = document.getElementById('bookingModal');
        const closeModalBtn = document.getElementById('closeModalBtn'), bookingForm = document.getElementById('bookingForm');
        const calendarTabBtn = document.getElementById('calendarTabBtn'), statusTabBtn = document.getElementById('statusTabBtn');
        const anonymousTabBtn = document.getElementById('anonymousTabBtn'), lookupTabBtn = document.getElementById('lookupTabBtn');
        const calendarView = document.getElementById('calendarView'), statusView = document.getElementById('statusView');
        const anonymousView = document.getElementById('anonymousView'), lookupView = document.getElementById('lookupView');
        const adminOnlyControls = document.getElementById('adminOnlyControls'), cancelSelectedBtn = document.getElementById('cancelSelectedBtn');
        const downloadExcelBtn = document.getElementById('downloadExcelBtn'), uploadExcelBtn = document.getElementById('uploadExcelBtn');
        const golfCourseFilterContainer = document.getElementById('golfCourseFilterContainer');
        const statusFilterContainer = document.getElementById('statusFilterContainer');
        const statusTableHead = document.getElementById('statusTableHead');
        const anonymousYearSelector = document.getElementById('anonymousYearSelector');
        const lookupBtn = document.getElementById('lookupBtn');
        const noticeModal = document.getElementById('noticeModal');
        const closeNoticeBtn = document.getElementById('closeNoticeBtn');
        const noticeLink = document.getElementById('noticeLink');

        document.addEventListener('DOMContentLoaded', async () => {
            // 데모에선 바로 앱 표시
            loginScreen.classList.add('hidden');
            mainApp.classList.remove('hidden');
            renderApp();
        });

        function renderApp() {
            const isManager = currentUser && currentUser.name === '신석중';
            anonymousTabBtn.classList.toggle('hidden', !isManager);
            lookupTabBtn.classList.toggle('hidden', !isManager);
            setupGolfCourseFilters();
            setupStatusFilter();
            setupSorting();
            renderCalendar();
            renderStatus();

            // 버튼 바인딩 (다운로드 동작)
            downloadExcelBtn?.addEventListener('click', downloadExcel);

            const noticeShown = localStorage.getItem('golf_notice_202509_demo');
            if (!noticeShown) {
                noticeModal.style.display = 'flex';
                localStorage.setItem('golf_notice_202509_demo', 'true');
            }
        }

        function setupGolfCourseFilters() {
            if (golfCourseFilterContainer.childElementCount > 0) return;
            let checkboxesHtml = '<div class="flex flex-wrap items-center gap-x-4 gap-y-2">';
            CALENDAR_GOLF_COURSES.forEach(course => {
                checkboxesHtml += \`<div class="flex items-center"><input id="filter-\${course}" type="checkbox" value="\${course}" class="golf-course-filter h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked><label for="filter-\${course}" class="ml-2 text-sm text-gray-900">\${course}</label></div>\`;
            });
            checkboxesHtml += \`<div class="flex items-center border-l pl-4 ml-2"><input id="filter-my-bookings" type="checkbox" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"><label for="filter-my-bookings" class="ml-2 text-sm font-semibold text-gray-900">내 예약건</label></div>\`;
            checkboxesHtml += '</div>';
            golfCourseFilterContainer.innerHTML = checkboxesHtml;
            golfCourseFilterContainer.addEventListener('change', renderCalendar);
        }

        function setupStatusFilter() {
            if (statusFilterContainer.childElementCount > 0) return;
            const statuses = ['전체', ...new Set(bookings.map(b => b.Status || '미정').sort())];
            let checkboxesHtml = '';
            statuses.forEach(status => {
                const id = \`status-filter-\${status.replace(/\\s+/g, '-')}\`;
                checkboxesHtml += \`<div class="flex items-center"><input id="\${id}" type="checkbox" value="\${status}" class="status-filter-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked><label for="\${id}" class="ml-1 text-sm text-gray-900">\${status}</label></div>\`;
            });
            statusFilterContainer.innerHTML = checkboxesHtml;
            statusFilterContainer.addEventListener('change', (e) => {
                const allCheckbox = document.getElementById('status-filter-전체');
                const otherCheckboxes = Array.from(document.querySelectorAll('.status-filter-checkbox:not(#status-filter-전체)'));
                if (e.target.id === 'status-filter-전체') {
                    otherCheckboxes.forEach(cb => cb.checked = allCheckbox.checked);
                } else {
                    allCheckbox.checked = otherCheckboxes.every(cb => cb.checked);
                }
                renderStatus();
            });
        }

        function setupSorting() {
            statusTableHead.addEventListener('click', (e) => {
                const header = e.target.closest('th');
                if (header && header.dataset.sort) {
                    const newSortColumn = header.dataset.sort;
                    if (sortColumn === newSortColumn) {
                        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortColumn = newSortColumn;
                        sortDirection = 'asc';
                    }
                    renderStatus();
                }
            });
        }

        function isWeekendOrHoliday(dateStr) {
            if (holidays[dateStr]) return true;
            const date = new Date(dateStr);
            const day = date.getDay();
            return day === 0 || day === 6;
        }

        function renderCalendar() {
            calendarEl.innerHTML = '';
            const calendarBookings = bookings.filter(b => CALENDAR_GOLF_COURSES.includes(b['Golf Course']));
            const selectedCourses = Array.from(document.querySelectorAll('.golf-course-filter:checked')).map(cb => cb.value);
            const showOnlyMyBookings = document.getElementById('filter-my-bookings')?.checked;
            let filteredBookings = calendarBookings;
            if (selectedCourses.length < CALENDAR_GOLF_COURSES.length) {
                 filteredBookings = filteredBookings.filter(b => selectedCourses.includes(b['Golf Course']));
            }
            if (showOnlyMyBookings) {
                filteredBookings = filteredBookings.filter(b => b.Name === currentUser.name);
            }
            const bookingMap = new Map();
            filteredBookings.forEach(booking => {
                const dateKey = booking['Date'];
                if (!bookingMap.has(dateKey)) bookingMap.set(dateKey, new Set());
                bookingMap.get(dateKey).add(booking['Golf Course']);
            });
            const courseAbbr = { '레이크우드': '레이크', '스카이밸리': '스카이', '세라지오': '세라', '힐드로사이': '힐드로' };
            const isMobile = window.innerWidth < 768;
            const today = new Date();
            const todayStr = \`\${today.getFullYear()}-\${String(today.getMonth() + 1).padStart(2, '0')}-\${String(today.getDate()).padStart(2, '0')}\`;
            let currentDate = new Date();
            const limitDate = new Date(2025, 11, 31); 
            while(currentDate <= limitDate) {
                const year = currentDate.getFullYear(), month = currentDate.getMonth();
                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                const monthlyBookings = bookings.filter(b => {
                    const bookingDate = new Date(b.Date);
                    return bookingDate >= firstDayOfMonth && bookingDate <= lastDayOfMonth;
                });
                const userMonthlyBookings = monthlyBookings.filter(b => b.Name === currentUser.name);
                const quotaCounts = {
                    lakewood_weekday: userMonthlyBookings.filter(b => b['Golf Course'] === '레이크우드' && !isWeekendOrHoliday(b.Date)).length,
                    lakewood_weekend: userMonthlyBookings.filter(b => b['Golf Course'] === '레이크우드' && isWeekendOrHoliday(b.Date)).length,
                    skyvalley: userMonthlyBookings.filter(b => b['Golf Course'] === '스카이밸리').length,
                    hillydesicy: userMonthlyBookings.filter(b => b['Golf Course'] === '힐드로사이').length,
                    seragio_weekday: userMonthlyBookings.filter(b => b['Golf Course'] === '세라지오' && !isWeekendOrHoliday(b.Date)).length,
                    seragio_weekend: userMonthlyBookings.filter(b => b['Golf Course'] === '세라지오' && isWeekendOrHoliday(b.Date)).length
                };
                const currentUserQuota = userQuotas[currentUser.name] || {};
                const quotaHtml = `<div class="text-xs text-gray-600 grid grid-cols-3 gap-1 mb-1">
                    <span>레이크(주중): ${quotaCounts.lakewood_weekday}/${currentUserQuota.Lakewood_Weekday || 0}</span>
                    <span>레이크(주말): ${quotaCounts.lakewood_weekend}/${currentUserQuota.Lakewood_Weekend || 0}</span>
                    <span>스카이밸리: ${quotaCounts.skyvalley}/${currentUserQuota.SkyValley || 0}</span>
                    <span>힐드로사이: ${quotaCounts.hillydesicy}/${currentUserQuota.HillydeSicy || 0}</span>
                    <span>세라지오(주중): ${quotaCounts.seragio_weekday}/${currentUserQuota.Seragio_Weekday || 0}</span>
                    <span>세라지오(주말): ${quotaCounts.seragio_weekend}/${currentUserQuota.Seragio_Weekend || 0}</span>
                </div>`;
                let warnings = [];
                const lakewoodWeekdayCount = monthlyBookings.filter(b => b['Golf Course'] === '레이크우드' && !isWeekendOrHoliday(b.Date)).length;
                const lakewoodWeekendCount = monthlyBookings.filter(b => b['Golf Course'] === '레이크우드' && isWeekendOrHoliday(b.Date)).length;
                if (lakewoodWeekdayCount >= 9) warnings.push('<div class="text-red-500 font-bold text-sm">※ 레이크우드 주중 한도 초과</div>');
                if (lakewoodWeekendCount >= 6) warnings.push('<div class="text-red-500 font-bold text-sm">※ 레이크우드 주말 한도 초과</div>');
                const seragioWeekdayCount = monthlyBookings.filter(b => b['Golf Course'] === '세라지오' && !isWeekendOrHoliday(b.Date)).length;
                const seragioWeekendCount = monthlyBookings.filter(b => b['Golf Course'] === '세라지오' && isWeekendOrHoliday(b.Date)).length;
                if (seragioWeekdayCount >= 5) warnings.push('<div class="text-red-500 font-bold text-sm">※ 세라지오 주중 한도 초과</div>');
                if (seragioWeekendCount >= 3) warnings.push('<div class="text-red-500 font-bold text-sm">※ 세라지오 주말 한도 초과</div>');
                const monthContainer = document.createElement('div');
                monthContainer.className = 'calendar-month bg-white p-6 rounded-lg shadow';
                monthContainer.innerHTML = `<div class="text-left mb-2 min-h-[4.5rem]">${quotaHtml}<div>${warnings.join('')}</div></div><div class="text-xl font-bold text-center mb-4">${year}년 ${month + 1}월</div><div class="grid grid-cols-7 gap-1 text-center text-sm font-semibold text-gray-600 mb-2"><div class="text-red-500">일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div class="text-blue-500">토</div></div>`;
                const dayGrid = document.createElement('div');
                dayGrid.className = 'grid grid-cols-7 gap-1 text-center';
                for (let j = 0; j < new Date(year, month, 1).getDay(); j++) dayGrid.innerHTML += '<div></div>';
                const daysInMonth = new Date(year, month + 1, 0).getDate();
                for (let day = 1; day <= daysInMonth; day++) {
                    const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                    const dayOfWeek = new Date(year, month, day).getDay();
                    let dayColor = '';
                    if (dayOfWeek === 0 || holidays[dateStr]) dayColor = 'text-red-500';
                    else if (dayOfWeek === 6) dayColor = 'text-blue-500';
                    const dayCell = document.createElement('div');
                    dayCell.className = 'day-cell p-1 rounded-md';
                    if (dateStr === todayStr) dayCell.classList.add('border-2', 'border-blue-500');
                    let bookingHtml = '';
                    if (bookingMap.has(dateStr)) {
                        dayCell.classList.add('bg-gray-100');
                        const coursesOnDate = Array.from(bookingMap.get(dateStr));
                        coursesOnDate.sort((a, b) => CALENDAR_GOLF_COURSES.indexOf(a) - CALENDAR_GOLF_COURSES.indexOf(b));
                        coursesOnDate.forEach(course => { 
                            const displayName = isMobile ? (courseAbbr[course] || course) : course;
                            const textColor = GOLF_COURSE_COLORS[course] || 'text-gray-800';
                            bookingHtml += `<div class="booking-info ${textColor} font-semibold rounded px-1 truncate">${displayName}</div>`; 
                        });
                    }
                    dayCell.innerHTML = `<div class="day-number font-medium ${dayColor}">${day}</div>` + bookingHtml;
                    dayCell.addEventListener('click', () => openBookingModal(null, dateStr));
                    dayGrid.appendChild(dayCell);
                }
                monthContainer.appendChild(dayGrid);
                calendarEl.appendChild(monthContainer);
                currentDate.setMonth(currentDate.getMonth() + 1);
            }
        }

        function renderStatus() {
            statusTableBody.innerHTML = '';
            const isManager = currentUser && currentUser.name === '신석중';
            const selectedStatuses = Array.from(document.querySelectorAll('.status-filter-checkbox:checked')).map(cb => cb.value);
            let statusFilteredBookings = bookings;
            if (!selectedStatuses.includes('전체')) {
                statusFilteredBookings = bookings.filter(b => selectedStatuses.includes(b.Status || '미정'));
            }

            let filteredBookings = isManager ? statusFilteredBookings : statusFilteredBookings.filter(b => b['Name'] === currentUser.name);
            
            const sortedBookings = [...filteredBookings].sort((a, b) => {
                const valA = a[sortColumn] || '';
                const valB = b[sortColumn] || '';
                let comparison = 0;
                if (sortColumn === 'Team') {
                    comparison = parseInt(valA, 10) - parseInt(valB, 10);
                } else {
                    comparison = String(valA).localeCompare(String(valB));
                }
                return sortDirection === 'asc' ? comparison : -comparison;
            });

            adminOnlyControls.classList.toggle('hidden', !isManager);
            cancelSelectedBtn.classList.toggle('hidden', !currentUser);
            if (sortedBookings.length === 0) {
                 statusTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-10">해당 조건의 예약 내역이 없습니다.</td></tr>`;
                 return;
            }
            sortedBookings.forEach(booking => {
                const row = document.createElement('tr');
                let statusStyle = "border-b border-gray-200 hover:bg-gray-100";
                if (booking['Status'] === '완료') statusStyle = "border-b border-gray-200 bg-sky-100 text-blue-700 font-medium";
                row.className = statusStyle;
                let displayTime = '-';
                const timeValue = booking['Time'];
                if (timeValue && typeof timeValue === 'string') {
                    const match = timeValue.match(/(\\d{1,2}:\\d{2})/);
                    displayTime = match ? match[0] : timeValue;
                } else if (timeValue) displayTime = timeValue;
                
                const displayDate = booking['Date'] ? booking['Date'].substring(5) : '-';

                // ✅ Name/Date/Golf Course 식별자도 data-*로 포함
                row.innerHTML = `<td class="py-3 px-6"><input type="checkbox" class="booking-checkbox" data-id="${booking.id}" data-name="${booking['Name']}" data-date="${booking['Date']}" data-course="${booking['Golf Course']}"></td><td class="py-3 px-6">${booking['Golf Course']}</td><td class="py-3 px-6">${booking['Name']}</td><td class="py-3 px-6">${displayDate}</td><td class="py-3 px-6">${booking['Team']}</td><td class="py-3 px-6">${displayTime}</td><td class="py-3 px-6">${booking['Status'] || '-'}</td><td class="py-3 px-6">${booking['Comment'] || '-'}</td>`;
                if (isManager || booking['Name'] === currentUser.name) {
                    row.style.cursor = 'pointer';
                    row.addEventListener('click', (e) => { if (e.target.type !== 'checkbox') openBookingModal(booking); });
                }
                statusTableBody.appendChild(row);
            });

            document.querySelectorAll('#statusTableHead th[data-sort]').forEach(th => {
                th.querySelector('.sort-indicator').textContent = '';
            });
            const activeHeader = document.querySelector(`#statusTableHead th[data-sort="${sortColumn}"]`);
            if (activeHeader) {
                activeHeader.querySelector('.sort-indicator').textContent = sortDirection === 'asc' ? ' ▲' : ' ▼';
            }
        }
        
        function openBookingModal(booking = null, date = null) {
            bookingForm.reset();
            const isManager = currentUser.name === '신석중';
            const userNameInput = document.getElementById('userName');
            const bookingTimeInput = document.getElementById('bookingTime');
            const bookingStatusInput = document.getElementById('bookingStatus');
            [userNameInput, bookingTimeInput, bookingStatusInput].forEach(input => {
                input.disabled = !isManager;
                input.classList.toggle('bg-gray-200', !isManager);
            });
            document.getElementById('bookingDate').addEventListener('change', (e) => updateAvailableGolfCourses(e.target.value));
            if (booking) {
                document.getElementById('modalTitle').textContent = '예약 수정';
                originalBookingForLog = { ...booking };
                const golfCourseSelect = document.getElementById('golfCourse');
                golfCourseSelect.innerHTML = '';
                MODAL_GOLF_COURSES.forEach(course => {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    golfCourseSelect.appendChild(option);
                });
                document.getElementById('bookingId').value = booking.id;
                golfCourseSelect.value = booking['Golf Course'];
                userNameInput.value = booking['Name'];
                document.getElementById('bookingDate').value = booking['Date'];
                document.getElementById('numberOfTeams').value = booking['Team'];
                bookingTimeInput.value = booking['Time'];
                bookingStatusInput.value = booking['Status'];
                document.getElementById('notes').value = booking['Comment'];
            } else {
                document.getElementById('modalTitle').textContent = '예약 신청';
                originalBookingForLog = null;
                userNameInput.value = currentUser.name;
                const targetDate = date || new Date().toISOString().split('T')[0];
                document.getElementById('bookingDate').value = targetDate;
                updateAvailableGolfCourses(targetDate);
            }
            bookingModal.style.display = 'flex';
        }

        function isWeekendOrHoliday(dateStr) {
            if (holidays[dateStr]) return true;
            const date = new Date(dateStr);
            const day = date.getDay();
            return day === 0 || day === 6;
        }

        function updateAvailableGolfCourses(selectedDate) {
            const golfCourseSelect = document.getElementById('golfCourse');
            golfCourseSelect.innerHTML = '';
            if (!selectedDate) return;
            const isManager = currentUser.name === '신석중';
            const isDayWeekendOrHoliday = isWeekendOrHoliday(selectedDate);
            const dailyCounts = bookings.filter(b => b.Date === selectedDate).reduce((acc, b) => {
                acc[b['Golf Course']] = (acc[b['Golf Course']] || 0) + 1;
                return acc;
            }, {});
            const lakewoodDailyCount = dailyCounts['레이크우드'] || 0;
            const seragioDailyCount = dailyCounts['세라지오'] || 0;
            const isLakewoodOverDailyLimit = isDayWeekendOrHoliday ? lakewoodDailyCount >= 6 : lakewoodDailyCount >= 9;
            const isSeragioOverDailyLimit = isDayWeekendOrHoliday ? seragioDailyCount >= 3 : seragioDailyCount >= 5;
            const year = new Date(selectedDate).getFullYear();
            const month = new Date(selectedDate).getMonth();
            const firstDayOfMonth = new Date(year, month, 1);
            const lastDayOfMonth = new Date(year, month + 1, 0);
            const userMonthlyBookings = bookings.filter(b => {
                const bookingDate = new Date(b.Date);
                return b.Name === currentUser.name && bookingDate >= firstDayOfMonth && bookingDate <= lastDayOfMonth;
            });
            const userQuotaCounts = {
                lakewood_weekday: userMonthlyBookings.filter(b => b['Golf Course'] === '레이크우드' && !isWeekendOrHoliday(b.Date)).length,
                lakewood_weekend: userMonthlyBookings.filter(b => b['Golf Course'] === '레이크우드' && isWeekendOrHoliday(b.Date)).length,
                skyvalley: userMonthlyBookings.filter(b => b['Golf Course'] === '스카이밸리').length,
                hillydesicy: userMonthlyBookings.filter(b => b['Golf Course'] === '힐드로사이').length,
                seragio_weekday: userMonthlyBookings.filter(b => b['Golf Course'] === '세라지오' && !isWeekendOrHoliday(b.Date)).length,
                seragio_weekend: userMonthlyBookings.filter(b => b['Golf Course'] === '세라지오' && isWeekendOrHoliday(b.Date)).length
            };
            const currentUserQuota = userQuotas[currentUser.name] || {};
            MODAL_GOLF_COURSES.forEach(course => {
                let isOverDailyLimit = false;
                if (course === '레이크우드' && isLakewoodOverDailyLimit) isOverDailyLimit = true;
                if (course === '세라지오' && isSeragioOverDailyLimit) isOverDailyLimit = true;
                let isOverUserQuota = false;
                if (!isManager) {
                    if (course === '레이크우드') {
                        const quota = isDayWeekendOrHoliday ? currentUserQuota.Lakewood_Weekend : currentUserQuota.Lakewood_Weekday;
                        const count = isDayWeekendOrHoliday ? userQuotaCounts.lakewood_weekend : userQuotaCounts.lakewood_weekday;
                        if (count >= quota) isOverUserQuota = true;
                    } else if (course === '세라지오') {
                        const quota = isDayWeekendOrHoliday ? currentUserQuota.Seragio_Weekend : currentUserQuota.Seragio_Weekday;
                        const count = isDayWeekendOrHoliday ? userQuotaCounts.seragio_weekend : userQuotaCounts.seragio_weekday;
                        if (count >= quota) isOverUserQuota = true;
                    } else if (course === '스카이밸리' && userQuotaCounts.skyvalley >= currentUserQuota.SkyValley) isOverUserQuota = true;
                    else if (course === '힐드로사이' && userQuotaCounts.hillydesicy >= currentUserQuota.HillydeSicy) isOverUserQuota = true;
                }
                if (!isOverDailyLimit && !isOverUserQuota) {
                    const option = document.createElement('option');
                    option.value = course;
                    option.textContent = course;
                    golfCourseSelect.appendChild(option);
                }
            });
        }

        function postData(action, data) {
            // 데모: 서버 없이 성공 메세지만
            console.log('POST', action, data);
            return new Promise((resolve) => {
                setTimeout(() => {
                    alert(action + ' 처리(데모)');
                    resolve({ status: 'success', message: 'ok' });
                }, 300);
            });
        }

        function showLoading(isLoading) {
            const loadingOverlay = document.getElementById('loadingOverlay');
            if (isLoading) {
                document.body.style.cursor = 'wait';
                loadingOverlay.style.display = 'flex';
            } else {
                document.body.style.cursor = 'default';
                loadingOverlay.style.display = 'none';
            }
        }

        function downloadExcel() {
            if (!bookings || bookings.length === 0) return alert('다운로드할 데이터가 없습니다.');
            const headers = ["id", "Golf Course", "Name", "Date", "Team", "Time", "Status", "Comment"];
            const csv = Papa.unparse({ fields: headers, data: bookings });
            const blob = new Blob(["\\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'golf_bookings.csv';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // 폼 제출(데모)
        bookingForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            showLoading(true);
            try {
                const bookingData = {
                    id: document.getElementById('bookingId').value || String(Date.now()),
                    'Golf Course': document.getElementById('golfCourse').value,
                    Name: document.getElementById('userName').value,
                    Date: document.getElementById('bookingDate').value,
                    Team: document.getElementById('numberOfTeams').value,
                    Time: document.getElementById('bookingTime').value,
                    Status: document.getElementById('bookingStatus').value,
                    Comment: document.getElementById('notes').value
                };
                // 로컬에 추가(데모)
                const idx = bookings.findIndex(b => b.id === bookingData.id);
                if (idx >= 0) bookings[idx] = bookingData; else bookings.push(bookingData);
                renderStatus(); renderCalendar();
                bookingModal.style.display = 'none';
            } finally {
                showLoading(false);
            }
        });

        // ✅ 선택 취소 로직: Name/Date/Golf Course로 정확히 식별 후 id 재탐색
        cancelSelectedBtn.addEventListener('click', async () => {
            const checked = document.querySelectorAll('.booking-checkbox:checked');
            if (checked.length === 0) return alert('취소할 항목을 선택하세요.');
            const isManager = currentUser.name === '신석중';

            const keys = Array.from(checked).map(cb => ({
                Name: cb.dataset.name,
                Date: cb.dataset.date,
                GolfCourse: cb.dataset.course
            }));

            let idsToProcess = keys.map(k => {
                const found = bookings.find(b => b.Name === k.Name && b.Date === k.Date && b['Golf Course'] === k.GolfCourse);
                return found ? found.id : null;
            }).filter(Boolean);

            if (!isManager) {
                const mine = new Set(bookings.filter(b => b.Name === currentUser.name).map(b => b.id));
                const before = idsToProcess.length;
                idsToProcess = idsToProcess.filter(id => mine.has(id));
                if (idsToProcess.length < before) alert('자신의 예약만 취소할 수 있습니다. 타인의 예약을 제외하고 진행합니다.');
            }

            if (idsToProcess.length === 0) return alert('취소할 수 있는 예약이 없습니다.');

            if (confirm(`선택한 ${idsToProcess.length}개의 항목을 정말 취소 처리하시겠습니까? (상태가 '취소중'으로 변경됩니다)`)) {
                showLoading(true);
                try {
                    await postData('cancel', { user: currentUser.name, ids: idsToProcess, keys });
                    // 데모: 상태만 변경
                    bookings = bookings.map(b => idsToProcess.includes(b.id) ? { ...b, Status: '취소중' } : b);
                    renderStatus();
                } finally {
                    showLoading(false);
                }
            }
        });

        // 모달 트리거
        openModalBtn.addEventListener('click', () => openBookingModal());
        closeModalBtn.addEventListener('click', () => bookingModal.style.display = 'none');

        // 탭切替
        [calendarTabBtn, statusTabBtn, anonymousTabBtn, lookupTabBtn].forEach(tab => {
            tab.addEventListener('click', () => {
                calendarView.classList.add('hidden');
                statusView.classList.add('hidden');
                anonymousView.classList.add('hidden');
                lookupView.classList.add('hidden');
                [calendarTabBtn, statusTabBtn, anonymousTabBtn, lookupTabBtn].forEach(t => t.classList.remove('bg-lime-500', 'text-white'));
                
                tab.classList.add('bg-lime-500', 'text-white');
                if (tab.id === 'calendarTabBtn') calendarView.classList.remove('hidden');
                else if (tab.id === 'statusTabBtn') statusView.classList.remove('hidden');
                else if (tab.id === 'lookupTabBtn') lookupView.classList.remove('hidden');
                else if (tab.id === 'anonymousTabBtn') anonymousView.classList.remove('hidden');
            });
        });

        // 공지
        noticeLink.addEventListener('click', (e) => { e.preventDefault(); noticeModal.style.display = 'flex'; });
        closeNoticeBtn.addEventListener('click', () => { noticeModal.style.display = 'none'; });
    </script>
</body>
</html>
