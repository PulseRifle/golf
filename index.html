<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>골프 예약 시스템</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/papaparse@5.3.0/papaparse.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .calendar-container { display: grid; grid-template-columns: repeat(2, 1fr); gap: 24px; }
        @media (max-width: 768px) { .calendar-container { grid-template-columns: 1fr; } }
        .day-cell { min-height: 50px; display: flex; flex-direction: column; justify-content: flex-start; align-items: center; cursor: pointer; }
        .booking-info { font-size: 10px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0, 0, 0, 0.5); display: none; justify-content: center; align-items: center; z-index: 1000; }
        .modal-content { background-color: white; padding: 32px; border-radius: 16px; width: 90%; max-width: 480px; }
        #anonymousView table th, #anonymousView table td { text-align: center; border: 1px solid #e5e7eb; padding: 4px; font-size: 0.75rem; }
        #anonymousView table th { background-color: #f9fafb; }
        #lookupResults table th, #lookupResults table td { border: 1px solid #e2e8f0; padding: 8px; text-align: center; }
        #lookupResults table th { background-color: #f8fafc; }
    </style>
</head>
<body class="bg-gray-100 p-8 md:p-16">

    <div id="loginScreen" class="flex flex-col items-center justify-center min-h-screen">
        <div class="bg-white rounded-3xl shadow-lg p-8 w-full max-w-sm">
            <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">로그인</h2>
            <form id="loginForm" class="space-y-4">
                <div>
                    <label for="loginUsername" class="block text-sm font-medium text-gray-700">아이디 (이름)</label>
                    <input type="text" id="loginUsername" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                </div>
                <div>
                    <label for="loginPassword" class="block text-sm font-medium text-gray-700">비밀번호</label>
                    <input type="password" id="loginPassword" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500">
                </div>
                
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <input id="rememberMe" name="remember-me" type="checkbox" class="h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded">
                        <label for="rememberMe" class="ml-2 block text-sm text-gray-900">아이디 저장</label>
                    </div>
                </div>

                <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg">로그인</button>
            </form>
        </div>
    </div>

    <div id="mainApp" class="hidden">
        <div class="bg-white rounded-3xl shadow-lg p-6 md:p-12 max-w-7xl mx-auto">
            <header class="flex flex-col md:flex-row justify-between items-center mb-8 gap-4">
                <div class="flex-grow">
                    <h1 class="text-3xl md:text-4xl font-extrabold text-gray-900">골프 예약 시스템</h1>
                    <a href="#" id="noticeLink" class="text-sm text-blue-600 hover:underline">이용 및 취소 안내(2025.9월)</a>
                </div>
                <div class="flex items-center space-x-4">
                    <button id="openModalBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full shadow-lg transform transition-transform active:scale-95">+ 신청</button>
                    <button id="logoutBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-6 rounded-full shadow-lg">로그아웃</button>
                </div>
            </header>
            <div class="mb-4 border-b border-gray-200">
                <nav class="flex space-x-4" aria-label="Tabs">
                    <button id="calendarTabBtn" class="px-3 py-2 font-medium text-sm rounded-md text-white bg-lime-500">캘린더</button>
                    <button id="statusTabBtn" class="px-3 py-2 font-medium text-sm rounded-md text-gray-500 hover:text-gray-700">현황</button>
                    <button id="lookupTabBtn" class="px-3 py-2 font-medium text-sm rounded-md text-gray-500 hover:text-gray-700 hidden">조회</button>
                    <button id="anonymousTabBtn" class="px-3 py-2 font-medium text-sm rounded-md text-gray-500 hover:text-gray-700 hidden">무기명</button>
                    <button id="entertainmentTabBtn" class="px-3 py-2 font-medium text-sm rounded-md text-gray-500 hover:text-gray-700 hidden">접대비 차감</button>
                </nav>
            </div>
            <div id="calendarView" class="tab-content">
                <div id="golfCourseFilterContainer" class="mb-4 p-4 bg-gray-50 rounded-lg border"></div>
                <div id="calendar" class="calendar-container"></div>
            </div>
            <div id="statusView" class="tab-content hidden">
                 <div class="flex flex-col md:flex-row justify-between items-center mb-4 gap-4">
                    <div>
                        <div id="statusFilterContainer" class="flex flex-wrap items-center gap-x-4 gap-y-2">
                        </div>
                        <div id="adminFilterContainer" class="hidden mt-4 flex flex-col md:flex-row items-start md:items-center gap-x-4 gap-y-2 p-4 bg-gray-50 rounded-lg border">
                            </div>
                    </div>
                    <div class="flex gap-2 self-start md:self-auto">
                        <div id="adminOnlyControls" class="flex gap-2 hidden">
                            <button id="downloadExcelBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full">엑셀 다운로드</button>
                            <button id="uploadExcelBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">엑셀 업로드</button>
                        </div>
                        <button id="cancelSelectedBtn" class="bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-2 px-6 rounded-full hidden transform transition-transform active:scale-95">선택 취소</button>
                    </div>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead id="statusTableHead" class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-2 md:px-6 text-left">선택</th>
                                <th class="py-3 px-2 md:px-6 text-left cursor-pointer" data-sort="Golf Course">Golf Course <span class="sort-indicator"></span></th>
                                <th class="py-3 px-2 md:px-6 text-left cursor-pointer" data-sort="Name">Name <span class="sort-indicator"></span></th>
                                <th class="py-3 px-2 md:px-6 text-left cursor-pointer" data-sort="Date">Date <span class="sort-indicator"></span></th>
                                <th class="py-3 px-2 md:px-6 text-center cursor-pointer" data-sort="Team">Team <span class="sort-indicator"></span></th>
                                <th class="py-3 px-2 md:px-6 text-left cursor-pointer" data-sort="Time">Time <span class="sort-indicator"></span></th>
                                <th class="py-3 px-2 md:px-6 text-left cursor-pointer" data-sort="Status">Status <span class="sort-indicator"></span></th>
                                <th class="py-3 px-2 md:px-6 text-left cursor-pointer" data-sort="Comment">Comment <span class="sort-indicator"></span></th>
                            </tr>
                        </thead>
                        <tbody id="statusTableBody" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>
            <div id="lookupView" class="tab-content hidden">
                <div class="bg-gray-50 p-4 rounded-lg border mb-4">
                    <div class="flex flex-col md:flex-row items-center gap-4">
                         <div class="flex items-center gap-2">
                             <label for="lookupName" class="text-sm font-medium text-gray-700">성명</label>
                             <input type="text" id="lookupName" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                         </div>
                         <div class="flex items-center gap-2">
                            <label for="lookupDate" class="text-sm font-medium text-gray-700">일자</label>
                            <input type="date" id="lookupDate" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm">
                         </div>
                         <button id="lookupBtn" class="w-full md:w-auto bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full self-end">조회</button>
                    </div>
                </div>
                <div id="lookupResults" class="mt-6 space-y-6"></div>
            </div>
            <div id="anonymousView" class="tab-content hidden">
                <div class="flex justify-end mb-4">
                    <select id="anonymousYearSelector" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5">
                        <option value="2024">2024년</option>
                        <option value="2025">2025년</option>
                    </select>
                </div>
                <div id="anonymousTableContainer" class="overflow-x-auto"></div>
            </div>
            <div id="entertainmentView" class="tab-content hidden">
                <div class="mb-6 p-6 bg-gradient-to-r from-blue-50 to-indigo-50 rounded-lg border border-blue-200">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-4">
                        <div>
                            <h3 class="text-xl font-bold text-gray-800 mb-2">접대비 총액</h3>
                            <p id="totalEntertainmentCost" class="text-3xl font-extrabold text-blue-600">₩0</p>
                        </div>
                        <div class="flex flex-col gap-3 w-full md:w-auto">
                            <div class="flex items-center gap-2">
                                <label for="commonEntertainment" class="text-sm font-medium text-gray-700 w-24">공통접대비</label>
                                <input type="text" id="commonEntertainment" class="block px-3 py-2 border border-gray-300 rounded-md shadow-sm w-40" placeholder="0">
                            </div>
                            <div class="flex items-center gap-2">
                                <label for="personalEntertainment" class="text-sm font-medium text-gray-700 w-24">개인접대비</label>
                                <input type="text" id="personalEntertainment" class="block px-3 py-2 border border-gray-300 rounded-md shadow-sm w-40" placeholder="0">
                            </div>
                            <button id="saveEntertainmentBtn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full shadow-lg transform transition-transform active:scale-95">저장</button>
                        </div>
                    </div>
                </div>
                <div class="mb-4 flex items-center gap-2">
                    <label for="entertainmentNameFilter" class="text-sm font-medium text-gray-700">이름:</label>
                    <select id="entertainmentNameFilter" class="px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-white">
                        <option value="전체">전체</option>
                    </select>
                </div>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-sm">
                        <thead class="bg-gray-200 text-gray-600 uppercase text-sm leading-normal">
                            <tr>
                                <th class="py-3 px-2 md:px-6 text-left cursor-pointer hover:bg-gray-300" data-sort="Golf Course">Golf Course <span class="sort-indicator"></span></th>
                                <th class="py-3 px-2 md:px-6 text-left cursor-pointer hover:bg-gray-300" data-sort="Name">Name <span class="sort-indicator"></span></th>
                                <th class="py-3 px-2 md:px-6 text-left cursor-pointer hover:bg-gray-300" data-sort="Date">Date <span class="sort-indicator"></span></th>
                                <th class="py-3 px-2 md:px-6 text-center cursor-pointer hover:bg-gray-300" data-sort="Team">Team <span class="sort-indicator"></span></th>
                                <th class="py-3 px-2 md:px-6 text-left cursor-pointer hover:bg-gray-300" data-sort="Time">Time <span class="sort-indicator"></span></th>
                                <th class="py-3 px-2 md:px-6 text-left cursor-pointer hover:bg-gray-300" data-sort="Status">Status <span class="sort-indicator"></span></th>
                                <th class="py-3 px-2 md:px-6 text-right cursor-pointer hover:bg-gray-300" data-sort="EE">접대비 <span class="sort-indicator"></span></th>
                            </tr>
                        </thead>
                        <tbody id="entertainmentTableBody" class="text-gray-600 text-sm font-light"></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="bookingModal" class="modal-overlay">
        <div class="modal-content">
            <h2 id="modalTitle" class="text-2xl font-bold mb-6 text-gray-800">예약 신청</h2>
            <form id="bookingForm" class="space-y-4">
                <input type="hidden" id="bookingId">
                <div><label for="userName" class="block text-sm font-medium text-gray-700">Name</label><input type="text" id="userName" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="bookingDate" class="block text-sm font-medium text-gray-700">Date</label><input type="date" id="bookingDate" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="golfCourse" class="block text-sm font-medium text-gray-700">Golf Course</label><select id="golfCourse" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md bg-white"></select></div>
                <div><label for="numberOfTeams" class="block text-sm font-medium text-gray-700">Team</label><input type="number" id="numberOfTeams" min="1" required class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="bookingTime" class="block text-sm font-medium text-gray-700">Time</label><input type="time" id="bookingTime" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="bookingStatus" class="block text-sm font-medium text-gray-700">Status</label><input type="text" id="bookingStatus" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div><label for="notes" class="block text-sm font-medium text-gray-700">Comment</label><input type="text" id="notes" class="mt-1 block w-full px-3 py-2 border border-gray-300 rounded-md"></div>
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="closeModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-full">취소</button>
                    <button type="submit" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-full transform transition-transform active:scale-95">저장</button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="noticeModal" class="modal-overlay">
        <div class="modal-content relative max-w-3xl max-h-[80vh] overflow-y-auto">
            <button id="closeNoticeBtn" class="absolute top-4 right-4 text-2xl text-gray-500 hover:text-gray-800">&times;</button>
            <h2 class="text-2xl font-bold mb-2 text-center text-gray-800">골프예약시스템 안내</h2>
            <p class="text-sm text-center text-gray-500 mb-6">[2025.09월, 인사총무팀]</p>
            <div class="prose max-w-none text-gray-700 space-y-4">
                <div>
                    <h3 class="text-lg font-bold">신청가능 골프회원권 현황</h3>
                    <div class="pl-4 mt-2 space-y-3">
                        <div>
                            <h4 class="font-semibold">1. 무기명회원권</h4>
                            <p class="text-sm">이용방식 : 각 법인 배정 횟수 내 무기명 사용 (1팀 회원가 적용)</p>
                            <ul class="list-disc list-inside text-sm space-y-1 mt-1">
                                <li><strong>📍 레이크우드CC</strong>
                                    <ul class="list-['-_'] list-inside ml-4">
                                        <li>월 이용횟수 : 주중 9회, 주말 6회</li>
                                        <li>배정대상 : 주중(국내영업팀 등 9개팀), 주말(국내영업담당임원 등 6명)</li>
                                    </ul>
                                </li>
                                <li><strong>📍 세라지오CC</strong>
                                    <ul class="list-['-_'] list-inside ml-4">
                                        <li>월 이용횟수 : 주중 5회, 주말 3회</li>
                                        <li>대체 이용 : 스카이밸리 1회 대체 사용 가능</li>
                                        <li>배정현황 : 기명회원권 미보유 정회원 등(주중 3회, 주말 2회)</li>
                                        <li>신청 가능 잔여분 : 주중 2회, 주말 1회</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                        <div>
                            <h4 class="font-semibold">2. 선불제회원권</h4>
                            <ul class="list-disc list-inside text-sm space-y-1 mt-1">
                                <li><strong>대상 골프장</strong> : 스카이밸리CC, 힐드로사이CC</li>
                                <li><strong>비용 구조</strong> : 총 비용 80만원/팀 (선불금에서 차감)</li>
                                <li><strong>지원 내역</strong> : 인사총무팀 지원(50만원), 개인/공통접대비(30만원)</li>
                                <li><strong>적용가격</strong> : 일반 인터넷회원가 (회원특가 없음)</li>
                                <li><strong>⚠️ 주의사항</strong> : 반기말(6월/12월) 인사총무팀에서 접대비 일괄 차감. 접대비 사용시 차감 금액을 미리 고려하여 사용 필요</li>
                            </ul>
                        </div>
                    </div>
                </div>
                <div>
                    <h3 class="text-lg font-bold">🎯 골프장 예약방법</h3>
                    <ul class="list-disc list-inside text-sm space-y-1 mt-2">
                        <li><strong>무기명/선불제회원권</strong>: 골프 예약 시스템을 통한 예약</li>
                        <li><strong>오픈 순서</strong> : 임원 → 국내영업팀 9개팀 → 국내영업 외 팀 (오픈 주기: 반기초마다)</li>
                        <li><strong>기타 예약</strong> : 월 횟수 미배정 또는 대중 오픈 예약일 이용 희망시 담당자(신석중 과장)에게 연락</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-bold">❌ 예약취소</h3>
                     <ul class="list-disc list-inside text-sm space-y-1 mt-2">
                        <li><strong>일반 취소</strong>: 시스템 취소는 티오프일 8일 전까지 가능 (골프장별 취소기준 상이)</li>
                        <li><strong>우천취소</strong>: 골프장 기준에 따라 가능, 당일 골프장에 직접 연락 후 취소 진행</li>
                    </ul>
                </div>
                <div>
                    <h3 class="text-lg font-bold">⏰ 티오프 당일 안내</h3>
                    <ul class="list-disc list-inside text-sm space-y-1 mt-2">
                        <li><strong>체크인</strong>: 티오프 시간 30분 전 체크인 완료</li>
                        <li><strong>특이사항 통보</strong>: 티오프 후 특이사항 발생시 당일 또는 익영업일에 담당자(신석중 과장)에게 메모 전달</li>
                        <li><strong>우천으로 인한 취소</strong>: 홀아웃 등으로 인한 차감금액 상이 등</li>
                    </ul>
                </div>
                 <div>
                    <h3 class="text-lg font-bold">📞 문의사항</h3>
                     <p class="text-sm mt-2">신석중 과장 (인사총무팀)</p>
                </div>
            </div>
        </div>
    </div>

    <div id="uploadModal" class="modal-overlay">
         <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6">엑셀 파일 업로드</h2>
            <form id="uploadForm" class="space-y-4">
                <input type="file" id="excelFile" accept=".csv" required class="block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                <div class="flex justify-end space-x-4 pt-4">
                    <button type="button" id="closeUploadModalBtn" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-full">취소</button>
                    <button type="submit" class="bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">업로드</button>
                </div>
            </form>
        </div>
    </div>


    <div id="loadingOverlay" class="modal-overlay" style="display: none;">
        <div class="animate-spin rounded-full h-16 w-16 border-t-4 border-b-4 border-blue-500"></div>
    </div>

    <script>
        // ##### 설정 (Configuration) #####
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycby-xf0NKlY0LHjCA-cPL3iq243XzgoIJ87vtvhlEfxj1zRnei7tXZFGwN9f9cQ4nhMu/exec';
        
        const CALENDAR_GOLF_COURSES = ['레이크우드', '스카이밸리', '세라지오', '힐드로사이'];
        const MODAL_GOLF_COURSES = ['레이크우드', '스카이밸리', '세라지오', '힐드로사이'];

        const GOLF_COURSE_COLORS = {
            '레이크우드': 'text-black',
            '스카이밸리': 'text-blue-600',
            '세라지오': 'text-green-600',
            '힐드로사이': 'text-red-600'
        };

        const holidays = {
            '2024-01-01': '신정', '2024-02-09': '설날', '2024-02-10': '설날', '2024-02-11': '설날', '2024-02-12': '설날 대체공휴일', '2024-03-01': '삼일절', '2024-04-10': '국회의원 선거', '2024-05-01': '근로자의 날', '2024-05-05': '어린이날', '2024-05-06': '어린이날 대체공휴일', '2024-05-15': '부처님 오신 날', '2024-06-06': '현충일', '2024-08-15': '광복절', '2024-09-16': '추석', '2024-09-17': '추석', '2024-09-18': '추석', '2024-10-03': '개천절', '2024-10-09': '한글날', '2024-12-25': '크리스마스',
            '2025-01-01': '신정', '2025-01-28': '설날', '2025-01-29': '설날', '2025-01-30': '설날', '2025-03-01': '삼일절', '2025-05-01': '근로자의 날', '2025-05-05': '어린이날', '2025-05-06': '부처님 오신 날', '2025-06-06': '현충일', '2025-08-15': '광복절', '2025-10-03': '개천절', '2025-10-06': '추석', '2025-10-07': '추석', '2025-10-08': '추석', '2025-10-09': '한글날', '2025-12-25': '크리스마스'
        };
        
        // [수정됨] 유효한 예약만 카운트하기 위한 필터 조건 함수
        // Status가 '예약완료', '예약중', '취소중'이고 MP가 0이 아닌 건만 카운트
        const VALID_STATUSES = ['예약완료', '예약중', '취소중'];
        const IS_VALID_FOR_COUNTING = (b) => b.MP != 0 && VALID_STATUSES.includes(b.Status);

        // 주중/주말 판단 함수 (WE 컬럼 기반)
        // 'WE' 컬럼이 "주 말"이면 주말, 공란이면 주중
        const isWeekendBooking = (booking) => {
            return booking['WE'] === '주 말';
        };


        // ##### 전역 상태 변수 (Global State) #####
        let currentUser = null;
        let bookings = [];
        let userQuotas = {};
        let users = [];
        let originalBookingForLog = null;
        let sortColumn = 'Date';
        let sortDirection = 'asc';
        let entertainmentSortColumn = 'Date';
        let entertainmentSortDirection = 'asc';
        let entertainmentNameFilter = '전체';
        let allEntertainmentLogs = []; // ▼▼▼ [수정 1] 전역 변수 추가 ▼▼▼
        
        // ##### DOMContentLoaded 이벤트 리스너 #####
        document.addEventListener('DOMContentLoaded', async () => {
            // ##### DOM 요소 변수 (DOM Element Variables) #####
            const loginScreen = document.getElementById('loginScreen');
            const mainApp = document.getElementById('mainApp');
            const loginForm = document.getElementById('loginForm');
            const logoutBtn = document.getElementById('logoutBtn');
            const calendarEl = document.getElementById('calendar');
            const statusTableBody = document.getElementById('statusTableBody');
            const openModalBtn = document.getElementById('openModalBtn');
            const bookingModal = document.getElementById('bookingModal');
            const closeModalBtn = document.getElementById('closeModalBtn');
            const bookingForm = document.getElementById('bookingForm');
            const calendarTabBtn = document.getElementById('calendarTabBtn');
            const statusTabBtn = document.getElementById('statusTabBtn');
            const anonymousTabBtn = document.getElementById('anonymousTabBtn');
            const lookupTabBtn = document.getElementById('lookupTabBtn');
            const calendarView = document.getElementById('calendarView');
            const statusView = document.getElementById('statusView');
            const anonymousView = document.getElementById('anonymousView');
            const lookupView = document.getElementById('lookupView');
            const adminOnlyControls = document.getElementById('adminOnlyControls');
            const cancelSelectedBtn = document.getElementById('cancelSelectedBtn');
            const downloadExcelBtn = document.getElementById('downloadExcelBtn');
            const uploadExcelBtn = document.getElementById('uploadExcelBtn');
            const uploadModal = document.getElementById('uploadModal');
            const closeUploadModalBtn = document.getElementById('closeUploadModalBtn');
            const uploadForm = document.getElementById('uploadForm');
            const golfCourseFilterContainer = document.getElementById('golfCourseFilterContainer');
            const statusFilterContainer = document.getElementById('statusFilterContainer');
            const adminFilterContainer = document.getElementById('adminFilterContainer');
            const statusTableHead = document.getElementById('statusTableHead');
            const anonymousYearSelector = document.getElementById('anonymousYearSelector');
            const lookupBtn = document.getElementById('lookupBtn');
            const noticeModal = document.getElementById('noticeModal');
            const closeNoticeBtn = document.getElementById('closeNoticeBtn');
            const noticeLink = document.getElementById('noticeLink');
            const entertainmentTabBtn = document.getElementById('entertainmentTabBtn');
            const entertainmentView = document.getElementById('entertainmentView');
            const entertainmentTableBody = document.getElementById('entertainmentTableBody');
            const totalEntertainmentCost = document.getElementById('totalEntertainmentCost');
            const commonEntertainment = document.getElementById('commonEntertainment');
            const personalEntertainment = document.getElementById('personalEntertainment');
            const saveEntertainmentBtn = document.getElementById('saveEntertainmentBtn');
            const entertainmentNameFilterSelect = document.getElementById('entertainmentNameFilter');

            // ##### 초기화 함수 호출 #####
            showLoading(true);
            try {
                await fetchInitialData();
                initializeLoginState();
            } catch (error) {
                console.error("초기화 실패:", error);
                alert("애플리케이션을 시작하는 데 실패했습니다. 페이지를 새로고침 해주세요.");
            } finally {
                showLoading(false);
            }

            // ##### 이벤트 리스너 설정 #####
            setupEventListeners();
        
            // ##### 함수 영역 (Functions) #####

            // --- 초기화 및 로그인 관련 ---
            function initializeLoginState() {
                const savedUser = sessionStorage.getItem('golf_currentUser');
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    const isValidUser = users.some(u => u.name === currentUser.name && u.phone === currentUser.phone);
                    if (isValidUser) {
                        showMainApp();
                    } else {
                        sessionStorage.removeItem('golf_currentUser');
                        showLoginScreen();
                    }
                } else {
                    showLoginScreen();
                }
            }

            function showLoginScreen() {
                const savedUsername = localStorage.getItem('golf_username');
                const savedPassword = localStorage.getItem('golf_password');
                if (savedUsername && savedPassword) {
                    document.getElementById('loginUsername').value = savedUsername;
                    document.getElementById('loginPassword').value = savedPassword;
                    document.getElementById('rememberMe').checked = true;
                }
                loginScreen.classList.remove('hidden');
                mainApp.classList.add('hidden');
            }
            
            function showMainApp() {
                loginScreen.classList.add('hidden');
                mainApp.classList.remove('hidden');
                renderApp();
            }

            // --- 앱 렌더링 관련 ---
            function renderApp() {
                const isManager = currentUser && currentUser.name === '신석중';
                anonymousTabBtn.classList.toggle('hidden', !isManager);
                lookupTabBtn.classList.toggle('hidden', !isManager);
                entertainmentTabBtn.classList.toggle('hidden', !isManager);
                setupGolfCourseFilters();
                setupStatusFilter();
                setupAdminFilters();
                renderCalendar();
                renderStatus();
                if(isManager) {
                    renderAnonymousView();
                    renderEntertainmentView();
                }

                const noticeShown = localStorage.getItem('golf_notice_202509');
                if (!noticeShown) {
                    noticeModal.style.display = 'flex';
                    localStorage.setItem('golf_notice_202509', 'true');
                }
            }

            function showLoading(isLoading) {
                const loadingOverlay = document.getElementById('loadingOverlay');
                if (isLoading) {
                    document.body.style.cursor = 'wait';
                    loadingOverlay.style.display = 'flex';
                } else {
                    document.body.style.cursor = 'default';
                    loadingOverlay.style.display = 'none';
                }
            }

            async function fetchInitialData() {
                try {
                    const response = await fetch(`${SCRIPT_URL}?action=read`);
                    if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                    const data = await response.json();
                    bookings = data.bookings;
                    users = data.users;
                    allEntertainmentLogs = data.entertainmentData || []; // ▼▼▼ [수정 2] 데이터 수신 ▼▼▼
                    userQuotas = data.quotas.reduce((acc, q) => {
                        acc[q.Name] = q;
                        return acc;
                    }, {});
                } catch (error) {
                    console.error('Error fetching initial data:', error);
                    alert('데이터를 불러오는 데 실패했습니다.');
                    throw error; // 에러를 다시 던져서 상위에서 처리하도록 함
                }
            }
            
            // --- UI 컴포넌트 설정 ---
            function setupGolfCourseFilters() {
                if (golfCourseFilterContainer.childElementCount > 0) return;
                let checkboxesHtml = '<div class="flex flex-wrap items-center gap-x-4 gap-y-2">';
                CALENDAR_GOLF_COURSES.forEach(course => {
                    checkboxesHtml += `<div class="flex items-center"><input id="filter-${course}" type="checkbox" value="${course}" class="golf-course-filter h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked><label for="filter-${course}" class="ml-2 text-sm text-gray-900">${course}</label></div>`;
                });
                checkboxesHtml += `<div class="flex items-center border-l pl-4 ml-2"><input id="filter-my-bookings" type="checkbox" class="h-4 w-4 text-green-600 focus:ring-green-500 border-gray-300 rounded"><label for="filter-my-bookings" class="ml-2 text-sm font-semibold text-gray-900">내 예약건</label></div>`;
                checkboxesHtml += '</div>';
                golfCourseFilterContainer.innerHTML = checkboxesHtml;
            }

            function setupStatusFilter() {
                if (statusFilterContainer.childElementCount > 0) return;
                const statuses = ['전체', ...new Set(bookings.map(b => b.Status || '미정').sort())];
                let checkboxesHtml = '';
                statuses.forEach(status => {
                    const id = `status-filter-${status.replace(/\s+/g, '-')}`;
                    checkboxesHtml += `<div class="flex items-center"><input id="${id}" type="checkbox" value="${status}" class="status-filter-checkbox h-4 w-4 text-blue-600 focus:ring-blue-500 border-gray-300 rounded" checked><label for="${id}" class="ml-1 text-sm text-gray-900">${status}</label></div>`;
                });
                statusFilterContainer.innerHTML = checkboxesHtml;
            }

            function setupAdminFilters() {
                if (adminFilterContainer.childElementCount > 0) adminFilterContainer.innerHTML = '';

                const courses = ['전체', ...[...new Set(bookings.map(b => b['Golf Course']))].sort()];
                const names = ['전체', ...[...new Set(bookings.map(b => b.Name))].sort()];
                const dates = ['전체', ...[...new Set(bookings.map(b => b.Date))].sort((a,b) => b.localeCompare(a))];

                let filtersHtml = `
                        <div class="flex items-center gap-2 w-full md:w-auto">
                            <label for="adminFilterCourse" class="text-sm font-medium text-gray-700">골프장</label>
                            <select id="adminFilterCourse" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
                                ${courses.map(c => `<option value="${c}">${c}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex items-center gap-2 w-full md:w-auto">
                            <label for="adminFilterName" class="text-sm font-medium text-gray-700">이름</label>
                            <select id="adminFilterName" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
                                ${names.map(n => `<option value="${n}">${n}</option>`).join('')}
                            </select>
                        </div>
                        <div class="flex items-center gap-2 w-full md:w-auto">
                            <label for="adminFilterDate" class="text-sm font-medium text-gray-700">날짜</label>
                            <select id="adminFilterDate" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm text-sm">
                                ${dates.map(d => `<option value="${d}">${d}</option>`).join('')}
                            </select>
                        </div>
                `;
                adminFilterContainer.innerHTML = filtersHtml;

                document.getElementById('adminFilterCourse').addEventListener('change', renderStatus);
                document.getElementById('adminFilterName').addEventListener('change', renderStatus);
                document.getElementById('adminFilterDate').addEventListener('change', renderStatus);
            }

            function setupSorting() {
                statusTableHead.addEventListener('click', (e) => {
                    const header = e.target.closest('th');
                    if (header && header.dataset.sort) {
                        const newSortColumn = header.dataset.sort;
                        if (sortColumn === newSortColumn) {
                            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            sortColumn = newSortColumn;
                            sortDirection = 'asc';
                        }
                        renderStatus();
                    }
                });
            }

            // --- 뷰 렌더링 ---
            function renderCalendar() {
                calendarEl.innerHTML = '';
                // [수정됨] IS_VALID_FOR_COUNTING 필터를 사용하여 캘린더에 표시할 예약만 가져옵니다.
                const calendarBookings = bookings.filter(b => CALENDAR_GOLF_COURSES.includes(b['Golf Course']) && IS_VALID_FOR_COUNTING(b));
                const selectedCourses = Array.from(document.querySelectorAll('.golf-course-filter:checked')).map(cb => cb.value);
                const showOnlyMyBookings = document.getElementById('filter-my-bookings').checked;
                let filteredBookings = calendarBookings;
                if (selectedCourses.length < CALENDAR_GOLF_COURSES.length) {
                     filteredBookings = filteredBookings.filter(b => selectedCourses.includes(b['Golf Course']));
                }
                if (showOnlyMyBookings) {
                    filteredBookings = filteredBookings.filter(b => b.Name === currentUser.name);
                }
                const bookingMap = new Map();
                filteredBookings.forEach(booking => {
                    const dateKey = booking['Date'];
                    if (!bookingMap.has(dateKey)) bookingMap.set(dateKey, new Set());
                    bookingMap.get(dateKey).add(booking['Golf Course']);
                });
                const courseAbbr = { '레이크우드': '레이크', '스카이밸리': '스카이', '세라지오': '세라', '힐드로사이': '힐드로' };
                const isMobile = window.innerWidth < 768;
                const today = new Date();
                const todayStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}-${String(today.getDate()).padStart(2, '0')}`;

                // [수정됨] 10월~12월 캘린더만 표시
                const currentYear = today.getFullYear();
                let currentDate = new Date(currentYear, 9, 1); // 10월 1일부터 시작 (월은 0부터 시작하므로 9=10월)
                const limitDate = new Date(currentYear, 11, 31); // 12월 31일까지

                while(currentDate <= limitDate) {
                    const year = currentDate.getFullYear(), month = currentDate.getMonth();
                    const firstDayOfMonth = new Date(year, month, 1);
                    const lastDayOfMonth = new Date(year, month + 1, 0);
                    
                    // [수정됨] IS_VALID_FOR_COUNTING 필터를 사용하여 월간 사용량을 계산합니다.
                    const monthlyBookings = bookings.filter(b => {
                        const bookingDate = new Date(b.Date);
                        return bookingDate >= firstDayOfMonth && bookingDate <= lastDayOfMonth && IS_VALID_FOR_COUNTING(b);
                    });

                    const userMonthlyBookings = monthlyBookings.filter(b => b.Name === currentUser.name);
                    const quotaCounts = {
                        lakewood_weekday: userMonthlyBookings.filter(b => b['Golf Course'] === '레이크우드' && !isWeekendBooking(b)).length,
                        lakewood_weekend: userMonthlyBookings.filter(b => b['Golf Course'] === '레이크우드' && isWeekendBooking(b)).length,
                        skyvalley: userMonthlyBookings.filter(b => b['Golf Course'] === '스카이밸리').length,
                        hillydesicy: userMonthlyBookings.filter(b => b['Golf Course'] === '힐드로사이').length,
                        seragio_weekday: userMonthlyBookings.filter(b => b['Golf Course'] === '세라지오' && !isWeekendBooking(b)).length,
                        seragio_weekend: userMonthlyBookings.filter(b => b['Golf Course'] === '세라지오' && isWeekendBooking(b)).length
                    };
                    const currentUserQuota = userQuotas[currentUser.name] || {};
                    const quotaHtml = `<div class="text-xs text-gray-600 grid grid-cols-3 gap-1 mb-1">
                        <span>레이크(주중): ${quotaCounts.lakewood_weekday}/${currentUserQuota.Lakewood_Weekday || 0}</span>
                        <span>레이크(주말): ${quotaCounts.lakewood_weekend}/${currentUserQuota.Lakewood_Weekend || 0}</span>
                        <span>스카이밸리: ${quotaCounts.skyvalley}/${currentUserQuota.SkyValley || 0}</span>
                        <span>힐드로사이: ${quotaCounts.hillydesicy}/${currentUserQuota.HillydeSicy || 0}</span>
                        <span>세라지오(주중): ${quotaCounts.seragio_weekday}/${currentUserQuota.Seragio_Weekday || 0}</span>
                        <span>세라지오(주말): ${quotaCounts.seragio_weekend}/${currentUserQuota.Seragio_Weekend || 0}</span>
                    </div>`;
                    let warnings = [];
                    const lakewoodWeekdayCount = monthlyBookings.filter(b => b['Golf Course'] === '레이크우드' && !isWeekendBooking(b)).length;
                    const lakewoodWeekendCount = monthlyBookings.filter(b => b['Golf Course'] === '레이크우드' && isWeekendBooking(b)).length;
                    if (lakewoodWeekdayCount >= 9) warnings.push('<div class="text-red-500 font-bold text-sm">※ 레이크우드 주중 한도 초과</div>');
                    if (lakewoodWeekendCount >= 6) warnings.push('<div class="text-red-500 font-bold text-sm">※ 레이크우드 주말 한도 초과</div>');
                    const seragioWeekdayCount = monthlyBookings.filter(b => b['Golf Course'] === '세라지오' && !isWeekendBooking(b)).length;
                    const seragioWeekendCount = monthlyBookings.filter(b => b['Golf Course'] === '세라지오' && isWeekendBooking(b)).length;
                    if (seragioWeekdayCount >= 5) warnings.push('<div class="text-red-500 font-bold text-sm">※ 세라지오 주중 한도 초과</div>');
                    if (seragioWeekendCount >= 3) warnings.push('<div class="text-red-500 font-bold text-sm">※ 세라지오 주말 한도 초과</div>');
                    const monthContainer = document.createElement('div');
                    monthContainer.className = 'calendar-month bg-white p-6 rounded-lg shadow';
                    monthContainer.innerHTML = `<div class="text-left mb-2 min-h-[4.5rem]">${quotaHtml}<div>${warnings.join('')}</div></div><div class="text-xl font-bold text-center mb-4">${year}년 ${month + 1}월</div><div class="grid grid-cols-7 gap-1 text-center text-sm font-semibold text-gray-600 mb-2"><div class="text-red-500">일</div><div>월</div><div>화</div><div>수</div><div>목</div><div>금</div><div class="text-blue-500">토</div></div>`;
                    const dayGrid = document.createElement('div');
                    dayGrid.className = 'grid grid-cols-7 gap-1 text-center';
                    for (let j = 0; j < new Date(year, month, 1).getDay(); j++) dayGrid.innerHTML += '<div></div>';
                    const daysInMonth = new Date(year, month + 1, 0).getDate();
                    for (let day = 1; day <= daysInMonth; day++) {
                        const dateStr = `${year}-${String(month + 1).padStart(2, '0')}-${String(day).padStart(2, '0')}`;
                        const dayOfWeek = new Date(year, month, day).getDay();
                        let dayColor = '';
                        if (dayOfWeek === 0 || holidays[dateStr]) dayColor = 'text-red-500';
                        else if (dayOfWeek === 6) dayColor = 'text-blue-500';
                        const dayCell = document.createElement('div');
                        dayCell.className = 'day-cell p-1 rounded-md';
                        if (dateStr === todayStr) dayCell.classList.add('border-2', 'border-blue-500');
                        let bookingHtml = '';
                        if (bookingMap.has(dateStr)) {
                            dayCell.classList.add('bg-gray-100');
                            const coursesOnDate = Array.from(bookingMap.get(dateStr));
                            coursesOnDate.sort((a, b) => CALENDAR_GOLF_COURSES.indexOf(a) - CALENDAR_GOLF_COURSES.indexOf(b));
                            coursesOnDate.forEach(course => { 
                                const displayName = isMobile ? (courseAbbr[course] || course) : course;
                                const textColor = GOLF_COURSE_COLORS[course] || 'text-gray-800';
                                bookingHtml += `<div class="booking-info ${textColor} font-semibold rounded px-1 truncate">${displayName}</div>`; 
                            });
                        }
                        dayCell.innerHTML = `<div class="day-number font-medium ${dayColor}">${day}</div>` + bookingHtml;
                        dayCell.addEventListener('click', () => openBookingModal(null, dateStr));
                        dayGrid.appendChild(dayCell);
                    }
                    monthContainer.appendChild(dayGrid);
                    calendarEl.appendChild(monthContainer);
                    currentDate.setMonth(currentDate.getMonth() + 1);
                }
            }
            
            function renderStatus() {
                statusTableBody.innerHTML = '';
                const isManager = currentUser && currentUser.name === '신석중';
                
                // 1. 상태 체크박스 필터링
                const selectedStatuses = Array.from(document.querySelectorAll('.status-filter-checkbox:checked')).map(cb => cb.value);
                let filteredBookings = bookings;
                if (!selectedStatuses.includes('전체')) {
                    filteredBookings = bookings.filter(b => selectedStatuses.includes(b.Status || '미정'));
                }

                // 2. 관리자 드롭다운 필터링
                adminFilterContainer.classList.toggle('hidden', !isManager);
                if (isManager) {
                    const selectedCourse = document.getElementById('adminFilterCourse').value;
                    const selectedName = document.getElementById('adminFilterName').value;
                    const selectedDate = document.getElementById('adminFilterDate').value;
                    
                    if (selectedCourse !== '전체') {
                        filteredBookings = filteredBookings.filter(b => b['Golf Course'] === selectedCourse);
                    }
                    if (selectedName !== '전체') {
                        filteredBookings = filteredBookings.filter(b => b.Name === selectedName);
                    }
                    if (selectedDate !== '전체') {
                        filteredBookings = filteredBookings.filter(b => b.Date === selectedDate);
                    }
                } else {
                    // 관리자가 아니면 본인 예약만 표시
                    filteredBookings = filteredBookings.filter(b => b['Name'] === currentUser.name);
                }
                
                // 3. 정렬
                const sortedBookings = [...filteredBookings].sort((a, b) => {
                    const valA = a[sortColumn] || '';
                    const valB = b[sortColumn] || '';
                    let comparison = 0;
                    if (sortColumn === 'Team') {
                        comparison = parseInt(valA, 10) - parseInt(valB, 10);
                    } else {
                        comparison = String(valA).localeCompare(String(valB));
                    }
                    return sortDirection === 'asc' ? comparison : -comparison;
                });

                adminOnlyControls.classList.toggle('hidden', !isManager);
                cancelSelectedBtn.classList.toggle('hidden', !currentUser);

                if (sortedBookings.length === 0) {
                     statusTableBody.innerHTML = `<tr><td colspan="8" class="text-center py-10">해당 조건의 예약 내역이 없습니다.</td></tr>`;
                     return;
                }

                sortedBookings.forEach(booking => {
                    const row = document.createElement('tr');
                    let statusStyle = "border-b border-gray-200 hover:bg-gray-100";
                    if (booking['Status'] === '완료') statusStyle = "border-b border-gray-200 bg-sky-100 text-blue-700 font-medium";
                    row.className = statusStyle;
                    
                    let displayTime = '-';
                    const timeValue = booking['Time'];
                    if (timeValue && typeof timeValue === 'string') {
                        const match = timeValue.match(/(\d{1,2}:\d{2})/);
                        displayTime = match ? match[0] : timeValue;
                    } else if (timeValue) displayTime = timeValue;
                    
                    const displayDate = booking['Date'] ? booking['Date'].substring(5) : '-';

                    row.innerHTML = `
                        <td class="py-3 px-2 md:px-6"><input type="checkbox" class="booking-checkbox" data-id="${booking.id}"></td>
                        <td class="py-3 px-2 md:px-6 whitespace-nowrap text-xs md:text-sm">${booking['Golf Course']}</td>
                        <td class="py-3 px-2 md:px-6 whitespace-nowrap text-xs md:text-sm">${booking['Name']}</td>
                        <td class="py-3 px-2 md:px-6 whitespace-nowrap text-xs md:text-sm">${displayDate}</td>
                        <td class="py-3 px-2 md:px-6 text-center whitespace-nowrap text-xs md:text-sm">${booking['Team']}</td>
                        <td class="py-3 px-2 md:px-6 whitespace-nowrap text-xs md:text-sm">${displayTime}</td>
                        <td class="py-3 px-2 md:px-6 whitespace-nowrap text-xs md:text-sm">${booking['Status'] || '-'}</td>
                        <td class="py-3 px-2 md:px-6 text-xs md:text-sm">${booking['Comment'] || '-'}</td>
                    `;
                    if (isManager || booking['Name'] === currentUser.name) {
                        row.style.cursor = 'pointer';
                        row.addEventListener('click', (e) => { if (e.target.type !== 'checkbox') openBookingModal(booking); });
                    }
                    statusTableBody.appendChild(row);
                });

                document.querySelectorAll('#statusTableHead th[data-sort]').forEach(th => {
                    th.querySelector('.sort-indicator').textContent = '';
                });
                const activeHeader = document.querySelector(`#statusTableHead th[data-sort="${sortColumn}"]`);
                if (activeHeader) {
                    activeHeader.querySelector('.sort-indicator').textContent = sortDirection === 'asc' ? ' ▲' : ' ▼';
                }
            }

            function renderAnonymousView() {
                const container = document.getElementById('anonymousTableContainer');
                const selectedYear = parseInt(anonymousYearSelector.value, 10);
                container.innerHTML = '';

                const categories = ['Lakewood_Weekday', 'Lakewood_Weekend', 'Seragio_Weekday', 'Seragio_Weekend'];
                const categoryNames = {
                    'Lakewood_Weekday': '레이크우드 주중', 'Lakewood_Weekend': '레이크우드 주말',
                    'Seragio_Weekday': '세라지오 주중', 'Seragio_Weekend': '세라지오 주말'
                };

                const processedData = {};
                const relevantBookings = bookings.filter(b => (b['Golf Course'] === '레이크우드' || b['Golf Course'] === '세라지오'));
                const userNames = [...new Set(relevantBookings.map(b => b.Name))].sort();

                userNames.forEach(name => {
                    processedData[name] = {};
                    const userBookings = relevantBookings.filter(b => b.Name === name && new Date(b.Date).getFullYear() === selectedYear);
                    userBookings.forEach(booking => {
                        const course = booking['Golf Course'];
                        const date = new Date(booking.Date);
                        const month = date.getMonth() + 1;
                        const day = date.getDate();
                        const isWeekend = isWeekendBooking(booking);
                        let category;
                        if (course === '레이크우드') category = isWeekend ? 'Lakewood_Weekend' : 'Lakewood_Weekday';
                        else if (course === '세라지오') category = isWeekend ? 'Seragio_Weekend' : 'Seragio_Weekday';
                        if (!processedData[name][category]) processedData[name][category] = {};
                        if (!processedData[name][category][month]) processedData[name][category][month] = [];
                        processedData[name][category][month].push(day);
                    });
                });

                let tableHtml = `<table class="min-w-full bg-white rounded-lg shadow-sm text-sm border-collapse">`;
                tableHtml += `<thead><tr><th rowspan="2" class="p-2 border">예약자명</th>`;
                categories.forEach(cat => tableHtml += `<th colspan="12" class="p-2 border">${categoryNames[cat]}</th>`);
                tableHtml += `</tr><tr>`;
                categories.forEach(() => {
                    for (let i = 1; i <= 12; i++) tableHtml += `<th class="p-2 border">${i}월</th>`;
                });
                tableHtml += `</tr></thead>`;
                tableHtml += `<tbody>`;
                userNames.forEach(name => {
                    tableHtml += `<tr><td class="p-2 border font-semibold">${name}</td>`;
                    categories.forEach(cat => {
                        for (let month = 1; month <= 12; month++) {
                            const days = processedData[name]?.[cat]?.[month]?.sort((a, b) => a - b).join(', ') || '';
                            tableHtml += `<td class="p-2 border">${days}</td>`;
                        }
                    });
                    tableHtml += `</tr>`;
                });
                tableHtml += `</tbody></table>`;
                container.innerHTML = tableHtml;
            }

            // ▼▼▼ [수정 4] 새 함수 `loadEntertainmentInputs` 추가 ▼▼▼
            /**
             * 현재 사용자의 최근 접대비 내역을 입력창에 불러옵니다.
             */
            function loadEntertainmentInputs() {
                if (!currentUser) return;

                // 1. 현재 사용자의 로그만 필터링
                const userLogs = allEntertainmentLogs.filter(log => log.Name === currentUser.name);
                
                if (userLogs.length === 0) {
                    // 저장된 내역이 없으면 입력창을 비웁니다.
                    commonEntertainment.value = '';
                    personalEntertainment.value = '';
                    return;
                }

                // 2. Timestamp를 기준으로 내림차순 정렬 (가장 최근 데이터가 0번째)
                userLogs.sort((a, b) => new Date(b.Timestamp) - new Date(a.Timestamp));
                const latestLog = userLogs[0];

                // 3. '공통접대비'와 '개인접대비' 값을 가져옵니다.
                const commonValue = latestLog['공통접대비'] || '0';
                const personalValue = latestLog['개인접대비'] || '0';
                
                // 4. 콤마를 포함하여 입력창에 값을 설정합니다.
                commonEntertainment.value = formatNumberWithCommas(commonValue);
                personalEntertainment.value = formatNumberWithCommas(personalValue);
            }

            function renderEntertainmentView() {
                loadEntertainmentInputs(); // ▼▼▼ [수정 5] 함수 호출 추가 ▼▼▼

                entertainmentTableBody.innerHTML = '';

                // 필터: MP != 0 && (Status == '예약완료' || Status == '우천취소' || Status == '예약중' || Status == '')
                let entertainmentBookings = bookings.filter(b =>
                    b.MP != 0 && (b.Status === '예약완료' || b.Status === '우천취소' || b.Status === '예약중' || b.Status === '' || !b.Status)
                );

                // 이름 드롭다운 채우기
                const uniqueNames = ['전체', ...new Set(entertainmentBookings.map(b => b['Name']).filter(n => n))];
                entertainmentNameFilterSelect.innerHTML = uniqueNames.map(name =>
                    `<option value="${name}" ${name === entertainmentNameFilter ? 'selected' : ''}>${name}</option>`
                ).join('');

                // 이름 필터 적용
                if (entertainmentNameFilter !== '전체') {
                    entertainmentBookings = entertainmentBookings.filter(b => b['Name'] === entertainmentNameFilter);
                }

                // 접대비 총액 계산: Google Sheet의 'EE' 컬럼 값 사용 (필터링 적용 후)
                let totalCost = 0;
                entertainmentBookings.forEach(booking => {
                    const cost = parseInt(booking['EE']) || 0;
                    totalCost += cost;
                });

                // 총액 표시
                totalEntertainmentCost.textContent = `₩${totalCost.toLocaleString()}`;

                // 정렬 적용
                entertainmentBookings.sort((a, b) => {
                    let aVal = a[entertainmentSortColumn];
                    let bVal = b[entertainmentSortColumn];

                    // 숫자 컬럼 처리 (Team, EE)
                    if (entertainmentSortColumn === 'Team' || entertainmentSortColumn === 'EE') {
                        aVal = parseInt(aVal) || 0;
                        bVal = parseInt(bVal) || 0;
                    } else {
                        aVal = String(aVal || '');
                        bVal = String(bVal || '');
                    }

                    if (entertainmentSortDirection === 'asc') {
                        return aVal > bVal ? 1 : aVal < bVal ? -1 : 0;
                    } else {
                        return aVal < bVal ? 1 : aVal > bVal ? -1 : 0;
                    }
                });

                // 정렬 표시 업데이트
                document.querySelectorAll('#entertainmentView th[data-sort]').forEach(th => {
                    const indicator = th.querySelector('.sort-indicator');
                    if (th.dataset.sort === entertainmentSortColumn) {
                        indicator.textContent = entertainmentSortDirection === 'asc' ? ' ▲' : ' ▼';
                    } else {
                        indicator.textContent = '';
                    }
                });

                // 테이블 렌더링
                if (entertainmentBookings.length === 0) {
                    entertainmentTableBody.innerHTML = `<tr><td colspan="7" class="text-center py-10">해당 조건의 예약 내역이 없습니다.</td></tr>`;
                    return;
                }

                entertainmentBookings.forEach(booking => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200 hover:bg-gray-100';

                    let displayTime = '-';
                    const timeValue = booking['Time'];
                    if (timeValue && typeof timeValue === 'string') {
                        const match = timeValue.match(/(\d{1,2}:\d{2})/);
                        displayTime = match ? match[0] : timeValue;
                    } else if (timeValue) displayTime = timeValue;

                    const displayDate = booking['Date'] ? booking['Date'].substring(5) : '-';

                    // 접대비: Google Sheet의 'EE' 컬럼 값 사용
                    const cost = parseInt(booking['EE']) || 0;

                    row.innerHTML = `
                        <td class="py-3 px-2 md:px-6 whitespace-nowrap text-xs md:text-sm">${booking['Golf Course']}</td>
                        <td class="py-3 px-2 md:px-6 whitespace-nowrap text-xs md:text-sm">${booking['Name']}</td>
                        <td class="py-3 px-2 md:px-6 whitespace-nowrap text-xs md:text-sm">${displayDate}</td>
                        <td class="py-3 px-2 md:px-6 text-center whitespace-nowrap text-xs md:text-sm">${booking['Team']}</td>
                        <td class="py-3 px-2 md:px-6 whitespace-nowrap text-xs md:text-sm">${displayTime}</td>
                        <td class="py-3 px-2 md:px-6 whitespace-nowrap text-xs md:text-sm">${booking['Status'] || '-'}</td>
                        <td class="py-3 px-2 md:px-6 text-right whitespace-nowrap text-xs md:text-sm font-semibold ${cost > 0 ? 'text-blue-600' : 'text-gray-400'}">₩${cost.toLocaleString()}</td>
                    `;
                    entertainmentTableBody.appendChild(row);
                });
            }

            // --- 데이터 처리 ---
            async function postData(action, data) {
                showLoading(true);
                try {
                    const response = await fetch(SCRIPT_URL, { method: 'POST', body: JSON.stringify({ action, ...data }) });
                    const result = await response.json();
                    if (result.status !== 'success') throw new Error(result.message);
                    alert(result.message);
                    await fetchInitialData(); // 데이터를 다시 불러옵니다.
                    renderApp(); // 앱을 다시 렌더링합니다.
                } catch (error) {
                    console.error(`Error with action ${action}:`, error);
                    alert(`오류가 발생했습니다: ${error.message}`);
                } finally {
                    showLoading(false);
                }
            }

            // --- 유틸리티 함수 ---
            function isWeekendOrHoliday(dateStr) {
                if (holidays[dateStr]) return true;
                const date = new Date(dateStr);
                const day = date.getDay();
                return day === 0 || day === 6;
            }

            // ▼▼▼ [수정 3] 헬퍼 함수 2개, `setupEventListeners` 밖으로 이동 ▼▼▼
            function formatNumberWithCommas(value) {
                // 숫자만 추출
                const number = String(value).replace(/[^0-9]/g, '');
                // 천원 단위 콤마 추가
                return number.replace(/\B(?=(\d{3})+(?!\d))/g, ',');
            }

            function removeCommas(value) {
                return String(value).replace(/,/g, '');
            }
            
            function updateAvailableGolfCourses(selectedDate) {
                const golfCourseSelect = document.getElementById('golfCourse');
                golfCourseSelect.innerHTML = '';
                if (!selectedDate) return;

                const isManager = currentUser.name === '신석중';

                // [수정됨] IS_VALID_FOR_COUNTING 필터를 사용하여 일일 총 예약 수를 계산합니다.
                const dailyCounts = bookings.filter(b => b.Date === selectedDate && IS_VALID_FOR_COUNTING(b)).reduce((acc, b) => {
                    acc[b['Golf Course']] = (acc[b['Golf Course']] || 0) + 1;
                    return acc;
                }, {});

                const isDayWeekendOrHoliday = isWeekendOrHoliday(selectedDate);

                // [수정됨] IS_VALID_FOR_COUNTING 필터를 사용하여 월간 예약 횟수를 계산합니다.
                const year = new Date(selectedDate).getFullYear();
                const month = new Date(selectedDate).getMonth();
                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);

                const userMonthlyBookings = bookings.filter(b => {
                    const bookingDate = new Date(b.Date);
                    return b.Name === currentUser.name && bookingDate >= firstDayOfMonth && bookingDate <= lastDayOfMonth && IS_VALID_FOR_COUNTING(b);
                });

                const userQuotaCounts = {
                    lakewood_weekday: userMonthlyBookings.filter(b => b['Golf Course'] === '레이크우드' && !isWeekendBooking(b)).length,
                    lakewood_weekend: userMonthlyBookings.filter(b => b['Golf Course'] === '레이크우드' && isWeekendBooking(b)).length,
                    skyvalley: userMonthlyBookings.filter(b => b['Golf Course'] === '스카이밸리').length,
                    hillydesicy: userMonthlyBookings.filter(b => b['Golf Course'] === '힐드로사이').length,
                    seragio_weekday: userMonthlyBookings.filter(b => b['Golf Course'] === '세라지오' && !isWeekendBooking(b)).length,
                    seragio_weekend: userMonthlyBookings.filter(b => b['Golf Course'] === '세라지오' && isWeekendBooking(b)).length
                };
                const currentUserQuota = userQuotas[currentUser.name] || {};

                MODAL_GOLF_COURSES.forEach(course => {
                    // 조건 1: 골프장별 일일 총 예약 한도 초과 여부 확인
                    let isOverDailyLimit = false;
                    if (course === '레이크우드') {
                        const lakewoodDailyCount = dailyCounts['레이크우드'] || 0;
                        if (isDayWeekendOrHoliday ? lakewoodDailyCount >= 6 : lakewoodDailyCount >= 9) {
                            isOverDailyLimit = true;
                        }
                    }
                    if (course === '세라지오') {
                        const seragioDailyCount = dailyCounts['세라지오'] || 0;
                        if (isDayWeekendOrHoliday ? seragioDailyCount >= 3 : seragioDailyCount >= 5) {
                            isOverDailyLimit = true;
                        }
                    }

                    // [수정됨] IS_VALID_FOR_COUNTING 필터를 사용하여 사용자가 이미 예약했는지 확인합니다.
                    const userHasBookedCourseToday = bookings.some(b => 
                        b.Name === currentUser.name &&
                        b.Date === selectedDate &&
                        b['Golf Course'] === course &&
                        IS_VALID_FOR_COUNTING(b)
                    );

                    // 조건 3: 사용자의 개인별 월간 할당량(Quota) 초과 여부 확인
                    let isOverUserQuota = false;
                    if (course === '레이크우드') {
                        const quota = isDayWeekendOrHoliday ? (currentUserQuota.Lakewood_Weekend || 0) : (currentUserQuota.Lakewood_Weekday || 0);
                        const count = isDayWeekendOrHoliday ? userQuotaCounts.lakewood_weekend : userQuotaCounts.lakewood_weekday;
                        if (count >= quota) isOverUserQuota = true;
                    } else if (course === '세라지오') {
                        const quota = isDayWeekendOrHoliday ? (currentUserQuota.Seragio_Weekend || 0) : (currentUserQuota.Seragio_Weekday || 0);
                        const count = isDayWeekendOrHoliday ? userQuotaCounts.seragio_weekend : userQuotaCounts.seragio_weekday;
                        if (count >= quota) isOverUserQuota = true;
                    } else if (course === '스카이밸리' && userQuotaCounts.skyvalley >= (currentUserQuota.SkyValley || 0)) {
                        isOverUserQuota = true;
                    } else if (course === '힐드로사이' && userQuotaCounts.hillydesicy >= (currentUserQuota.HillydeSicy || 0)) {
                        isOverUserQuota = true;
                    }

                    // 최종 확인: 관리자이거나, 모든 제한 조건에 해당하지 않을 경우에만 드롭다운에 추가
                    if (isManager || (!isOverDailyLimit && !userHasBookedCourseToday && !isOverUserQuota)) {
                        const option = document.createElement('option');
                        option.value = course;
                        option.textContent = course;
                        golfCourseSelect.appendChild(option);
                    }
                });
            }

            function openBookingModal(booking = null, date = null) {
                bookingForm.reset();
                const isManager = currentUser.name === '신석중';
                const userNameInput = document.getElementById('userName');
                const bookingTimeInput = document.getElementById('bookingTime');
                const bookingStatusInput = document.getElementById('bookingStatus');
                [userNameInput, bookingTimeInput, bookingStatusInput].forEach(input => {
                    input.disabled = !isManager;
                    input.classList.toggle('bg-gray-200', !isManager);
                });
                
                if (booking) {
                    document.getElementById('modalTitle').textContent = '예약 수정';
                    originalBookingForLog = { ...booking };
                    const golfCourseSelect = document.getElementById('golfCourse');
                    golfCourseSelect.innerHTML = '';
                    MODAL_GOLF_COURSES.forEach(course => {
                        const option = document.createElement('option');
                        option.value = course;
                        option.textContent = course;
                        golfCourseSelect.appendChild(option);
                    });
                    document.getElementById('bookingId').value = booking.id;
                    golfCourseSelect.value = booking['Golf Course'];
                    userNameInput.value = booking['Name'];
                    document.getElementById('bookingDate').value = booking['Date'];
                    document.getElementById('numberOfTeams').value = booking['Team'];
                    bookingTimeInput.value = booking['Time'];
                    bookingStatusInput.value = booking['Status'];
                    document.getElementById('notes').value = booking['Comment'];
                } else {
                    document.getElementById('modalTitle').textContent = '예약 신청';
                    originalBookingForLog = null;
                    userNameInput.value = currentUser.name;
                    const targetDate = date || new Date().toISOString().split('T')[0];
                    document.getElementById('bookingDate').value = targetDate;
                    document.getElementById('bookingStatus').value = '예약중';
                    updateAvailableGolfCourses(targetDate);
                }
                bookingModal.style.display = 'flex';
            }

            function downloadExcel() {
                if (bookings.length === 0) return alert('다운로드할 데이터가 없습니다.');
                const headers = ["id", "Golf Course", "Name", "Date", "Team", "Time", "Status", "Comment", "MP"];
                const csv = Papa.unparse({ fields: headers, data: bookings });
                const blob = new Blob(["\uFEFF" + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = 'golf_bookings.csv';
                link.click();
            }

            // --- 이벤트 리스너 설정 함수 ---
            function setupEventListeners() {
                loginForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const username = document.getElementById('loginUsername').value;
                    const password = document.getElementById('loginPassword').value;
                    const user = users.find(u => u.name === username && String(u.phone) === password);
                    if (user) {
                        currentUser = user;
                        sessionStorage.setItem('golf_currentUser', JSON.stringify(currentUser));
                        const rememberMe = document.getElementById('rememberMe').checked;
                        if (rememberMe) {
                            localStorage.setItem('golf_username', username);
                            localStorage.setItem('golf_password', password);
                        } else {
                            localStorage.removeItem('golf_username');
                            localStorage.removeItem('golf_password');
                        }
                        showMainApp();
                    } else { alert('아이디 또는 비밀번호가 일치하지 않습니다.'); }
                });

                logoutBtn.addEventListener('click', () => {
                    currentUser = null;
                    sessionStorage.removeItem('golf_currentUser');
                    showLoginScreen();
                });
                
                [calendarTabBtn, statusTabBtn, anonymousTabBtn, lookupTabBtn, entertainmentTabBtn].forEach(tab => {
                    tab.addEventListener('click', () => {
                        calendarView.classList.add('hidden');
                        statusView.classList.add('hidden');
                        anonymousView.classList.add('hidden');
                        lookupView.classList.add('hidden');
                        entertainmentView.classList.add('hidden');
                        [calendarTabBtn, statusTabBtn, anonymousTabBtn, lookupTabBtn, entertainmentTabBtn].forEach(t => t.classList.remove('bg-lime-500', 'text-white'));

                        tab.classList.add('bg-lime-500', 'text-white');
                        if (tab.id === 'calendarTabBtn') calendarView.classList.remove('hidden');
                        else if (tab.id === 'statusTabBtn') statusView.classList.remove('hidden');
                        else if (tab.id === 'lookupTabBtn') lookupView.classList.remove('hidden');
                        else if (tab.id === 'anonymousTabBtn') anonymousView.classList.remove('hidden');
                        else if (tab.id === 'entertainmentTabBtn') entertainmentView.classList.remove('hidden');
                    });
                });
                
                openModalBtn.addEventListener('click', () => openBookingModal());
                closeModalBtn.addEventListener('click', () => bookingModal.style.display = 'none');
                
                bookingForm.addEventListener('submit', async (e) => {
                    e.preventDefault();
                    const bookingData = {
                        'id': document.getElementById('bookingId').value, 'Golf Course': document.getElementById('golfCourse').value,
                        'Name': document.getElementById('userName').value, 'Date': document.getElementById('bookingDate').value,
                        'Team': document.getElementById('numberOfTeams').value, 'Time': document.getElementById('bookingTime').value,
                        'Status': document.getElementById('bookingStatus').value, 'Comment': document.getElementById('notes').value
                    };
                    if (!bookingData['Golf Course']) {
                        alert('선택한 날짜에 예약 가능한 골프장이 없습니다. 한도가 초과되었을 수 있습니다.');
                        return;
                    }
                    if (bookingData.id) {
                        let logParts = [];
                        if (bookingData.Time !== originalBookingForLog.Time) logParts.push("시간변경");
                        if (bookingData.Team != originalBookingForLog.Team) logParts.push("팀수변경");
                        const logMessage = logParts.length > 0 ? logParts.join('/') : "수정";
                        await postData('update', { user: currentUser.name, booking: bookingData, logMessage: logMessage });
                    } else {
                        const isManager = currentUser.name === '신석중';
                        if (!isManager) {
                            // [수정됨] IS_VALID_FOR_COUNTING 필터를 사용하여 중복 예약을 검사합니다.
                            const isDuplicate = bookings.some(b => 
                                b.Date === bookingData.Date && 
                                b['Golf Course'] === bookingData['Golf Course'] && 
                                b.Name === bookingData.Name &&
                                IS_VALID_FOR_COUNTING(b)
                            );
                            if (isDuplicate) {
                                alert('이미 해당 날짜에 동일한 골프장으로 유효한 예약 내역이 있습니다.');
                                return;
                            }
                        }
                        await postData('add', { user: currentUser.name, booking: bookingData });
                    }
                    bookingModal.style.display = 'none';
                });

                cancelSelectedBtn.addEventListener('click', async () => {
                    const checkedBoxes = document.querySelectorAll('.booking-checkbox:checked');
                    if (checkedBoxes.length === 0) return alert('취소할 항목을 선택하세요.');
                    const isManager = currentUser.name === '신석중';
                    let idsToProcess = Array.from(checkedBoxes).map(cb => cb.dataset.id).filter(id => id);
                    if (!isManager) {
                        const myBookingsIds = new Set(bookings.filter(b => b.Name === currentUser.name).map(b => b.id));
                        const originalLength = idsToProcess.length;
                        idsToProcess = idsToProcess.filter(id => myBookingsIds.has(id));
                        if (idsToProcess.length < originalLength) {
                            alert('자신의 예약만 취소할 수 있습니다. 타인의 예약을 제외하고 진행합니다.');
                        }
                    }
                    if (idsToProcess.length === 0) {
                        alert('취소할 수 있는 예약이 없습니다.');
                        return;
                    };
                    if (confirm(`선택한 ${idsToProcess.length}개의 항목을 정말 취소 처리하시겠습니까? (상태가 '취소중'으로 변경됩니다)`)) {
                        await postData('cancel', { user: currentUser.name, ids: idsToProcess });
                    }
                });

                golfCourseFilterContainer.addEventListener('change', renderCalendar);
                statusFilterContainer.addEventListener('change', (e) => {
                    const allCheckbox = document.getElementById('status-filter-전체');
                    const otherCheckboxes = Array.from(document.querySelectorAll('.status-filter-checkbox:not(#status-filter-전체)'));
                    if (e.target.id === 'status-filter-전체') {
                        otherCheckboxes.forEach(cb => cb.checked = allCheckbox.checked);
                    } else {
                        allCheckbox.checked = otherCheckboxes.every(cb => cb.checked);
                    }
                    renderStatus();
                });
                
                document.getElementById('bookingDate').addEventListener('change', (e) => updateAvailableGolfCourses(e.target.value));

                setupSorting();
                anonymousYearSelector.addEventListener('change', renderAnonymousView);
                
                noticeLink.addEventListener('click', (e) => { e.preventDefault(); noticeModal.style.display = 'flex'; });
                closeNoticeBtn.addEventListener('click', () => { noticeModal.style.display = 'none'; });
                downloadExcelBtn.addEventListener('click', downloadExcel);
                uploadExcelBtn.addEventListener('click', () => { uploadModal.style.display = 'flex'; });
                closeUploadModalBtn.addEventListener('click', () => { uploadModal.style.display = 'none'; });
                uploadForm.addEventListener('submit', (e) => {
                    e.preventDefault();
                    const file = document.getElementById('excelFile').files[0];
                    if (!file) return alert('파일을 선택해주세요.');
                    
                    Papa.parse(file, {
                        header: true, skipEmptyLines: true,
                        complete: async (results) => {
                            await postData('addMultiple', { user: currentUser.name, bookings: results.data });
                            uploadModal.style.display = 'none';
                        },
                        error: (err) => { alert('파일을 읽는 중 오류가 발생했습니다.'); console.error(err); }
                    });
                });

                // ▼▼▼ [수정 3] 헬퍼 함수 2개가 밖으로 이동되어 이 리스너만 남습니다. ▼▼▼
                commonEntertainment.addEventListener('input', (e) => {
                    e.target.value = formatNumberWithCommas(e.target.value);
                });

                personalEntertainment.addEventListener('input', (e) => {
                    e.target.value = formatNumberWithCommas(e.target.value);
                });

                // 접대비 저장 버튼
                saveEntertainmentBtn.addEventListener('click', async () => {
                    // 콤마 제거하여 숫자로 변환
                    const commonValue = removeCommas(commonEntertainment.value.trim());
                    const personalValue = removeCommas(personalEntertainment.value.trim());

                    if (!commonValue && !personalValue) {
                        alert('공통접대비 또는 개인접대비 중 하나 이상을 입력해주세요.');
                        return;
                    }

                    if (!confirm('접대비 정보를 저장하시겠습니까?')) {
                        return;
                    }

                    const entertainmentData = {
                        name: currentUser.name,
                        commonEntertainment: commonValue || '0',
                        personalEntertainment: personalValue || '0'
                    };

                    // [중요] postData를 사용하면, 성공 시 fetchInitialData가 다시 호출되고,
                    // renderApp() -> renderEntertainmentView() -> loadEntertainmentInputs()가 실행되어
                    // 방금 저장한 값이 자동으로 다시 로드됩니다.
                    await postData('saveEntertainment', entertainmentData);
                });

                // 접대비 이름 필터 변경
                entertainmentNameFilterSelect.addEventListener('change', (e) => {
                    entertainmentNameFilter = e.target.value;
                    renderEntertainmentView();
                });

                // 접대비 테이블 헤더 정렬
                document.querySelectorAll('#entertainmentView th[data-sort]').forEach(th => {
                    th.addEventListener('click', () => {
                        const column = th.dataset.sort;
                        if (entertainmentSortColumn === column) {
                            entertainmentSortDirection = entertainmentSortDirection === 'asc' ? 'desc' : 'asc';
                        } else {
                            entertainmentSortColumn = column;
                            entertainmentSortDirection = 'asc';
                        }
                        renderEntertainmentView();
                    });
                });
            } // setupEventListeners 함수 끝

            // 조회 로직
            lookupBtn.addEventListener('click', () => {
                const lookupName = document.getElementById('lookupName').value;
                const lookupDate = document.getElementById('lookupDate').value;
                const resultsDiv = document.getElementById('lookupResults');
                resultsDiv.innerHTML = '';

                if (lookupName) {
                    const targetUserQuota = userQuotas[lookupName];
                    if (!targetUserQuota) {
                        resultsDiv.innerHTML = `<p class="text-red-500">해당 사용자의 한도 정보를 찾을 수 없습니다.</p>`;
                        return;
                    }
                    const year = new Date().getFullYear();
                    const userBookingsForPeriod = bookings.filter(b => b.Name === lookupName && new Date(b.Date).getFullYear() === year && new Date(b.Date).getMonth() >= 8);
                    
                    // [수정됨] IS_VALID_FOR_COUNTING 필터를 사용하여 실제 사용 건수만 계산합니다.
                    const userUsedBookings = userBookingsForPeriod.filter(b => IS_VALID_FOR_COUNTING(b));

                    const usedCounts = {
                        Lakewood_Weekday: userUsedBookings.filter(b => b['Golf Course'] === '레이크우드' && !isWeekendBooking(b)).length,
                        Lakewood_Weekend: userUsedBookings.filter(b => b['Golf Course'] === '레이크우드' && isWeekendBooking(b)).length,
                        SkyValley: userUsedBookings.filter(b => b['Golf Course'] === '스카이밸리').length,
                        HillydeSicy: userUsedBookings.filter(b => b['Golf Course'] === '힐드로사이').length,
                        Seragio_Weekday: userUsedBookings.filter(b => b['Golf Course'] === '세라지오' && !isWeekendBooking(b)).length,
                        Seragio_Weekend: userUsedBookings.filter(b => b['Golf Course'] === '세라지오' && isWeekendBooking(b)).length
                    };
                    const monthlyUsage = {};
                    for (let i = 9; i <= 12; i++) monthlyUsage[i] = { Lakewood_Weekday: 0, Lakewood_Weekend: 0, SkyValley: 0, HillydeSicy: 0, Seragio_Weekday: 0, Seragio_Weekend: 0 };
                    userUsedBookings.forEach(b => {
                        const month = new Date(b.Date).getMonth() + 1;
                        if (month >= 9) {
                            const isWeekend = isWeekendBooking(b);
                            if (b['Golf Course'] === '레이크우드') monthlyUsage[month][isWeekend ? 'Lakewood_Weekend' : 'Lakewood_Weekday']++;
                            else if (b['Golf Course'] === '스카이밸리') monthlyUsage[month].SkyValley++;
                            else if (b['Golf Course'] === '힐드로사이') monthlyUsage[month].HillydeSicy++;
                            else if (b['Golf Course'] === '세라지오') monthlyUsage[month][isWeekend ? 'Seragio_Weekend' : 'Seragio_Weekday']++;
                        }
                    });
                    let resultHtml = `<h3 class="text-lg font-bold mb-2">${lookupName}님 조회 결과 (9월-12월)</h3>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <h4 class="font-semibold mb-2">연간 한도 및 사용 현황 (9월-12월)</h4>
                            <table class="w-full text-sm">
                                <thead><tr><th>항목</th><th>배정(4개월)</th><th>사용</th><th>잔여</th></tr></thead>
                                <tbody>
                                    <tr><td>레이크우드(주중)</td><td>${(targetUserQuota.Lakewood_Weekday || 0) * 4}</td><td>${usedCounts.Lakewood_Weekday}</td><td>${(targetUserQuota.Lakewood_Weekday || 0) * 4 - usedCounts.Lakewood_Weekday}</td></tr>
                                    <tr><td>레이크우드(주말)</td><td>${(targetUserQuota.Lakewood_Weekend || 0) * 4}</td><td>${usedCounts.Lakewood_Weekend}</td><td>${(targetUserQuota.Lakewood_Weekend || 0) * 4 - usedCounts.Lakewood_Weekend}</td></tr>
                                    <tr><td>스카이밸리</td><td>${(targetUserQuota.SkyValley || 0) * 4}</td><td>${usedCounts.SkyValley}</td><td>${(targetUserQuota.SkyValley || 0) * 4 - usedCounts.SkyValley}</td></tr>
                                    <tr><td>힐드로사이</td><td>${(targetUserQuota.HillydeSicy || 0) * 4}</td><td>${usedCounts.HillydeSicy}</td><td>${(targetUserQuota.HillydeSicy || 0) * 4 - usedCounts.HillydeSicy}</td></tr>
                                    <tr><td>세라지오(주중)</td><td>${(targetUserQuota.Seragio_Weekday || 0) * 4}</td><td>${usedCounts.Seragio_Weekday}</td><td>${(targetUserQuota.Seragio_Weekday || 0) * 4 - usedCounts.Seragio_Weekday}</td></tr>
                                    <tr><td>세라지오(주말)</td><td>${(targetUserQuota.Seragio_Weekend || 0) * 4}</td><td>${usedCounts.Seragio_Weekend}</td><td>${(targetUserQuota.Seragio_Weekend || 0) * 4 - usedCounts.Seragio_Weekend}</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div>
                             <h4 class="font-semibold mb-2">월별 사용 현황</h4>
                             <table class="w-full text-sm">
                                 <thead><tr><th>월</th><th>레이크(주중)</th><th>레이크(주말)</th><th>스카이밸리</th><th>힐드로사이</th><th>세라지오(주중)</th><th>세라지오(주말)</th></tr></thead>
                                 <tbody>`;
                    for(let i = 9; i <= 12; i++) resultHtml += `<tr><td>${i}월</td><td>${monthlyUsage[i].Lakewood_Weekday}</td><td>${monthlyUsage[i].Lakewood_Weekend}</td><td>${monthlyUsage[i].SkyValley}</td><td>${monthlyUsage[i].HillydeSicy}</td><td>${monthlyUsage[i].Seragio_Weekday}</td><td>${monthlyUsage[i].Seragio_Weekend}</td></tr>`;
                    resultHtml += `</tbody></table></div></div>`;
                    resultsDiv.innerHTML = resultHtml;

                } else if (lookupDate) {
                    const availableCourses = getAvailableCoursesForDate(lookupDate);
                       let resultHtml = `<h3 class="text-lg font-bold mb-2">${lookupDate} 예약 가능 여부 (현재 사용자 기준)</h3>
                                     <ul class="list-disc list-inside">`;
                    MODAL_GOLF_COURSES.forEach(course => {
                        const isAvailable = availableCourses.includes(course);
                        resultHtml += `<li>${course}: <span class="font-bold ${isAvailable ? 'text-green-600' : 'text-red-600'}">${isAvailable ? '가능' : '불가능'}</span></li>`;
                    });
                    resultHtml += `</ul>`;
                    resultsDiv.innerHTML = resultHtml;
                } else {
                    resultsDiv.innerHTML = '<p>조회할 이름 또는 날짜를 입력해주세요.</p>';
                }
            });
        });

    </script>
</body>
</html>
